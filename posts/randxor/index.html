<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>RandXor</title>
    <meta name="description" content="Review of of an unknown sample using interesting decryption, shellcode execution method and api hashing.">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/randxor/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="RandXor">
    <meta property="og:description" content="Review of of an unknown sample using interesting decryption, shellcode execution method and api hashing.">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="RandXor">
    <meta name="twitter:description" content="Review of of an unknown sample using interesting decryption, shellcode execution method and api hashing.">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/randxor/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/randxor/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/randxor/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>RandXor</h1>
        <small role="doc-subtitle">Review of of an unknown sample using interesting decryption, shellcode execution method and api hashing.</small>
        <p class="post-date">
            May 26, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>Looking at this sample, it sort of tries to be a word doc in that the icon and the translated title is: Xin An Tong [2023] No. 4 official document patch repair.</p>
<p>This can be seen in the resource section for this file:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image15.png" alt=""></p>
<p>It is however an EXE, that starts off with multiple anti-debug/vm functions.  The good thing here is that the symbols remain and a lot of the functions (including main) are labeled in such a way that reversing is straight forward.</p>
<p>Because of the anti-vm checks, the ScyllaHide plugin can only do so much.  </p>
<p>Some of the checks are:</p>
<pre tabindex="0"><code>IsDebuggerPresent
CheckRemoteDebuggerPresent
System Clock Checks
Memory capacity
Disk info
Proc count
Network Adapter info
</code></pre><p>Really we want to get down to the do/while loop where something is being decoded/decrypted:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image4.png" alt=""></p>
<p>To get by the checks, I first set a bp on main at 0x401845, then patched the first function call to actually jump to the do/while loop I want that occurs after the checks.  This was patched to jmp 0x4019fa as seen below on line 0x401856.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image7.png" alt=""></p>
<p>Right before that decrypt function is called, a few items to note.  The first value is the .data section of this file, the second is the size of 0x3c4 and the third is a starting seed value that will be used later as an srand seed.<img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image11.png" alt=""></p>
<p>It takes the result of the decrypt operation and looks to see if the first byte is 0xFC</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image2.png" alt=""></p>
<p>So I could visualize this better, I wrote a decryption program in C++, which I think shows what is going on here.  I’ll try to walk through that.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image14.png" alt=""></p>
<p>Looking at this first section, we can see that rand is seeded with the current system time.  This part seems odd but also a couple of notes about how rand works on C++.  Basically rand will give you a pseudo random number that is based on the seed given to srand.  So if you don’t call srand first, it would be the same as calling srand with a one, srand(1).  The other note about rand is that if you know or can guess the srand seed, you can generate the exact same random values each time it&rsquo;s called.  Normally system time is used so you have a unique seed value that shouldn’t be easy to guess.  </p>
<p>So why would the attacker get the victims system time for a decryption routine?  In this case, there is an algorithm where it converts the random number to something smaller and more predictable based on the first modulo with 0x1e, and therefore that is the largest the number could actually be (decimal 30).  Right after, that value is then used as a seed for rand and then two rounds of Xor can be seen above. In the end, what they are doing here and what I have mimicked in the c++ program is basically brute forcing the rand seed value that is needed for actual decryption.  The program knows it needs an 0xFC in the start position, so if that isn’t found it runs and tries again.  I observed this could be almost immediate or run a dozen times attempting to find the correct value.  However, because the first rand value has a small range, this still works pretty quick and is just looking for the result to be decimal 15.</p>
<p>Next part:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image8.png" alt=""></p>
<p>In the program, since we know we have the matching 0xFC, we can proceed with the rest of the algorithm here.</p>
<p>Example of this program running you can see the current value tests and then the found correct values before writing out the result.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image6.png" alt=""></p>
<p>Now that we have that out of the way, the next interesting thing this file does is the way it actually executes this new shellcode.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image12.png" alt=""></p>
<p>The VirtualProtect call is normal and is just making the region where this shellcode sits executable.  In the next part, WinHttpOpen is called and then WinHttpSetStatusCallback and finally WinHttpCloseHandle.  The way this executes code is with WinHttpSetStatusCallback.  It sets that executable memory region as the callback function and then the trigger is when the handle is closed.  So as soon as WinHttpCloseHandle is called, the shellcode will be executed.</p>
<p>The callback function receives 0xC00 as a flag which is:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image9.png" alt=""></p>
<p>The symbolic constant is a combo of:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image5.png" alt=""></p>
<p>With an explanation of:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image1.png" alt=""></p>
<p>Now that the shellcode is running, there are some interesting items of note there as well.</p>
<p>First its using standard api hashing:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image3.png" alt=""></p>
<p>Basically, ROR 0xd each letter and then add that to the last one to create a hash.  Since this is a very common method, we can do that same thing.  I’ll link a script I used at the end but by using this same method you can hash and create a rainbow table that can be used to decode the hex values as seen here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image16.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image13.png" alt=""></p>
<p>The functions resolved are:</p>
<pre tabindex="0"><code>InternetOpenA
InternetConnectA
HttpOpenRequestA
InternetSetOpenA
HttpSendRequestA
InternetReadFile
VirtualAlloc
</code></pre><p>The goal here is straightforward in that it connects to a url and then uses VirtualAlloc to execute the response.  This can be see as strings split up in the shellcode but the final request looks like this:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/randXor/image10.png" alt=""></p>
<p>The final payload as of right now is Cobalt Strike (which we won’t dive into now), however unsure if that was the payload at the time this was first seen or if it will be going forward.</p>
<h1 id="programsscripts">Programs/Scripts</h1>
<table>
<thead>
<tr>
<th>Type</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>C++ Program for decryption</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/randXor/randXorDecrypt.cpp">Link</a></td>
</tr>
<tr>
<td>API hashing script</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/apiHash.py">Link</a></td>
</tr>
</tbody>
</table>
<h1 id="iocs">IOCs</h1>
<table>
<thead>
<tr>
<th>IOC Desc</th>
<th>Type</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initial File Reviewed</td>
<td>SHA256</td>
<td>E2AD20B9F1816F5C546A1CC38D2C939961B55A03CB745663A9DEF52788E04F91</td>
</tr>
<tr>
<td>Final Stage DL</td>
<td>URL</td>
<td>hxxps://service-cn1708rw-1253795072.gz.apigw.tencentcs[.]com/api/auth/poral/log1</td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2024 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
