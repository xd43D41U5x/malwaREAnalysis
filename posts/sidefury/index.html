<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>SideFury</title>
    <meta name="description" content="Review of the SideFury Malware">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/sidefury/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="SideFury">
    <meta property="og:description" content="Review of the SideFury Malware">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="SideFury">
    <meta name="twitter:description" content="Review of the SideFury Malware">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/sidefury/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/sidefury/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/sidefury/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>SideFury</h1>
        <small role="doc-subtitle">Review of the SideFury Malware</small>
        <p class="post-date">
            February 21, 2022
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="analysis">Analysis</h1>
<p>I’ll start by saying this probably isn’t the right name, but based on write-ups I’ve seen similar but not exactly the same items.  It feels like a mash up between SideCopy/SideWinder and NightFury.</p>
<p>As a quick summary here is what the overall flow looks like.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image49.png" alt=""></p>
<p>This attack starts with a zip file being delivered to the user.  The zip file contains what would appear to an end user as a “docx”, however it&rsquo;s really a link file which is abusing the target parameter to pull external content, in this case the 2nd stage to be launched with mshta.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image13.png" alt=""></p>
<p>Upon closer review you can see there is a pdf document header in this “lnk” file as well:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image19.png" alt=""></p>
<p>The pdf doesn’t appear to contain open actions or js, but I would assume its there to add legitimacy to this attack and the end user thinks everything is ok.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image39.png" alt=""></p>
<p>Pulling down the referenced file is an hta file with javascript which is heavily obfuscated.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image48.png" alt=""></p>
<p>Sure we could just run it in a dynamic fashion and hope to snag IOCs and that would be the quickest way but if we really want to see what its doing we need to deob.  Using vscode or other debuggers here would work for parts of it but the problem with that approach is that its not just trying to run javascript but page based JS along with actual JS functions.  We don’t want or need any of that, so lets write a Python script to deob for us.  If you follow the logic through, we can port the decode and decrypt functions from JS to Python.</p>
<p>A link to the script I wrote is included at the end of this write-up, but basically it will go through, regex find the references to the main decode function (that calls the sub decode and decrypt functions), pulls the encoded string values and pushes those through our Python versions of those functions.  With that cleartext string, we can use similar regex to replace those references.  Now we have the entire thing in cleartext and its a simple matter of combining a few statements to see what its doing.  I should also note that in that same Python script, I created another function to search files like this using regex on the common function name format and look for what is most likely the main decode function using frequency analysis.  This might be good in the future to speed up deob.</p>
<p>Now looking at our cleartext script we can see the following.  It appears to be doing file searches for csc (c# compiler) version number, either 2 or 4.  Next, uses standard VBscript to look for .net framework version numbers, either 2 or 4.</p>
<p>CurrentStatus is the .NET version number.</p>
<p>ver = C# compiler number</p>
<p>Its now attempting to set an env variable via COMPLUS_Version</p>
<p>AddRegValueToTable.Environment(Process)(COMPLUS_Version) = CurrentStatus</p>
<p>Which will force that version to be run. From what I can tell, the only function in this not being used is abctest.  After deob script and moving some items around, we are more of less left with:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image17.png" alt=""></p>
<p>We are now left with some very long string values that I fully expect to be exe&rsquo;s or parts of them.</p>
<p>Lets do variable “so” first.  It gets split on &ldquo;.&rdquo;, then joined back together.  After putting this into ps and running, I noticed that there is nothing to split on. So it actually does nothing in this case.</p>
<p>This value then gets sent to the function sLarr, which is a normal way to convert base64 to a binary stream in js then execute “dash” with eval.  </p>
<p>We can do the same thing in Powershell:</p>
<p>$bytes = [System.Convert]::FromBase64String($so)</p>
<p>Then write it to a file:</p>
<p>[io.file]::WriteAllBytes(&rsquo;newfile.exe&rsquo;,$bytes)</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image25.png" alt=""></p>
<p>Writing out the other files some have a typical MZ header and others have the starting text we can strip off with a hex editor.  You end up with what looks like a dll named, &ldquo;preBotHta&rdquo;</p>
<p>There is a class called &ldquo;program&rdquo; with a method called work.  Now what we saw in the hta file makes sense.  After the eval executes the dll, the other two long strings that are suspected to be files are passed in as parameters.</p>
<p>This method/function takes the following passed to it:</p>
<p>public void Work(string dllBytes, string doc, string fileName)</p>
<p>So the first is the dllbytes, the second is the doc and the last is the filename.</p>
<p>dllbytes = vezbFYuvC</p>
<p>doc = vezbFYuvb</p>
<p>filename = Content Writing.docx</p>
<p>There is a reference to decompressing that base64 file (doc) and writing it out with the docx name which only seems to get called if certain conditions are met.  The doc file itself is blank and unsure why.  It could be that it wasn’t expected to be called.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image26.png" alt=""></p>
<p>It also looks like there are tons of checks for very specific AV products and will set different flags to true if it is a match.</p>
<p>Specifically flag 5 here for Kaspersky:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image16.png" alt=""></p>
<p>It checks for a winzip directory, then creates it if it doesn’t exist.<img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image28.png" alt=""></p>
<p>It then checks for an office directory, then creates it if it doesn’t exist.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image45.png" alt=""></p>
<p>It then creates two different lnk files in the startup folder for persistence.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image2.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image3.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image33.png" alt=""></p>
<p>Next it is calling “copyhttpfile_kespar”</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image11.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image7.png" alt=""></p>
<p>There is a string defined in this dll named httpFile (ref above) that is copied out/decoded in this function, I used powershell to also write this out.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image22.png" alt=""></p>
<p>After writing this file out, I decompressed it with 7-zip and opened it with notepad++, it is an hta file.  Which we have seen before.  Just a quick scan, it looks like it was the original file but it&rsquo;s not exact.</p>
<p>Using our deob program we can see its very similar with the same obfuscation but the file being written out is still called with the same eval function but It&rsquo;s not passing in any params when calling program work():</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image21.png" alt=""></p>
<p>Writing out this shows it&rsquo;s another .NET file, specifically showing RAT capabilities.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image20.png" alt=""></p>
<p>This file reaches out to the C2 url listed with the encryption key as the second parameter:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image31.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image38.png" alt=""></p>
<p>After the C2 is contacted, that “work” function now calls some “*USB*” functions:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image50.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image6.png" alt=""></p>
<p>It looks like its leveraging wmi event subscriptions and looking for USB device notifications.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image54.png" alt=""></p>
<p>Which appears to be looking for and copying specific files found on removable media:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image30.png" alt=""></p>
<p>It will copy them to here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image43.png" alt=""></p>
<p>It appears this is the sole purpose here which combined with the c2 call, I would assume file exfil.</p>
<p>Ok, going back to the initial program, lets see what it was doing with that dll that was passed in.  We can see that it copies a legit version of “charmap.exe” and also writes out the dll into that same path.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image40.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image41.png" alt=""></p>
<p>This format is srcfile, dstfile, overwrite (in this case true).</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image14.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image42.png" alt=""></p>
<p>This is being written to the “office” folder as:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image34.png" alt=""></p>
<p>And decoded here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image8.png" alt=""></p>
<p>It’s basically base64 encoded and gzipd again.</p>
<p>Its compiled and not dotnet here, VT shows this as NightFury Backdoor:</p>
<p><a href="https://www.google.com/url?q=https://www.virustotal.com/gui/file/a14a92559a2645b1ca755a3f39d11a7edeea1b2f4ef947c0f9a5f23c3ae80c5a/detection&amp;sa=D&amp;source=editors&amp;ust=1680898414311985&amp;usg=AOvVaw1pownwoKumgx1YPx3q_1RC">https://www.virustotal.com/gui/file/a14a92559a2645b1ca755a3f39d11a7edeea1b2f4ef947c0f9a5f23c3ae80c5a/detection</a></p>
<p>The one item to note here is the export:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image4.png" alt=""></p>
<p>Another note at this point is the dll file being written out here is also sharing the same directory with a legit windows exe.  In this specific instance its charmap and the dll is msftedit.  Looking at the modules charmap loads, you can see this is doing side loading of the dll from the current directory.  It’s similar to dll order jacking but instead of placing the malware in a higher order directory and waiting to be executed, its making a copy of a legit windows file, placing the dll next to it in the same directory and then executing that. The legit windows file will pick up that dll first and in this case will run the malicious version of the dll.</p>
<p>You can see the module being loaded from the legit proces here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image53.png" alt=""></p>
<p>Another item of note is a batch file being created:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image27.png" alt=""></p>
<p>Which decoded is just more persistence:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image12.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image52.png" alt=""></p>
<p>The batch file is being written to the winzip dir with config.bat as the name.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image29.png" alt=""></p>
<p>Going down the list of AV matches if its not Kaspersky, it executes the doc file here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image9.png" alt=""></p>
<p>Again, in this case the doc file is benign and blank.</p>
<p>Depending on which AV vendor path this program takes, it will also place items in different directories and use different persistence batch files.  </p>
<p>Here is an overall view of the strings, which gives a good view of the places its writing everything.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image32.png" alt=""></p>
<p>As I didn’t want to do this by hand but wanted to check all files stored as b64 strings, I wrote a quick powershell script to convert from b64 and then unzip with 7z.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image24.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image35.png" alt=""></p>
<p>The bat file contents are like we saw before and the the bat file bytes are registry mods for persistence:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image47.png" alt=""></p>
<p>Looping back to look at the compiled exe, I saw a long string and wrote that out and it looks like another version of preBotHta with another encryption key.  The guess is this exe is staging another Rat.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image5.png" alt=""></p>
<p>Going down through the list, this is another version of a similar RAT, as you can see encrypted communication and possible actions, such as downloadexe, process, registry, screen, etc.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image46.png" alt=""></p>
<p>There is also a checkin interval (5 sec):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image36.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image51.png" alt=""></p>
<p>You can see machine fingerprint information being collected here then encrypted with the previously seen key.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image18.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image44.png" alt=""></p>
<p>Basically taking these parameters:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image10.png" alt=""></p>
<p>And rc4 encrypting them with the key we saw before, then sending via a POST.</p>
<p>The next portion of this is somewhat interesting in that in this while true endless loop, it sends the system info and then based on the response to that takes some type of action:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image1.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image15.png" alt=""></p>
<p>So the result of “text3” gets converted via a one off xor routine and then that number is compared in the if/elseif condition checks.</p>
<p>Because Python has some issues with unsigned ints, I just compiled a snippet of this in c#/VisualStudio, to mimic the uint/string conversion.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image23.png" alt=""></p>
<p>The results of this match up and confirm the following possible string commands that could be returned by the attacker and the uint portion that matches as:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/sidefury/image37.png" alt=""></p>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Description</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>sideFuryDeob.py</td>
<td>Deob for JS</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/sideFuryDeob.py">Link</a></td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
