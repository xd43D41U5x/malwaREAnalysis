<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>3CX</title>
    <meta name="description" content="Review of the 3CX Malware Attack">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/3cx/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="3CX">
    <meta property="og:description" content="Review of the 3CX Malware Attack">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="3CX">
    <meta name="twitter:description" content="Review of the 3CX Malware Attack">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/3cx/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/3cx/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/3cx/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>3CX</h1>
        <small role="doc-subtitle">Review of the 3CX Malware Attack</small>
        <p class="post-date">
            April 5, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="summary">Summary</h1>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image6.png" alt=""></p>
<h2 id="physical-files-involved">Physical Files Involved</h2>
<ul>
<li>3CXDesktopApp.exe - Has a dependency for ffmpeg.dll.  This initial exe appears to be clean.</li>
<li>ffmpeg.dll - This dll has been modified at the entry point, so that even upon loading of the dll (no export calls), the malicious code would run. Note: this is an expected file for an electron app.</li>
<li>d3dcompiler_47.dll - This dll functions as normal, however has RC4 encrypted data added in the overlay.  Note: this is also an expected file for an electron app.</li>
</ul>
<h2 id="execution-flow">Execution Flow</h2>
<ol>
<li>
<p>3CXDesktopApp.exe loads ffmpeg.dll on launch.</p>
</li>
<li>
<p>ffmpeg.dll  does not load d3dcompiler_47.dll as a library but as a generic file read.</p>
</li>
<li>
<p>ffmpeg.dll uses a static stored key and decrypts the RC4 overlay based on a found position noted by 0xFEEDFACE.</p>
</li>
<li>
<p>A note about this encrypted data.  It was initially suggested that this was all shellcode and that it performed the remainder of the actions seen.  However, while the first small portion of this data is shellcode, its only purpose is to act as a loader for another dll, which was stored in the same encrypted data section.  I now see this dll hash available on VT as: CA5A66380563CA4C545F1676C23BD95D.</p>
</li>
<li>
<p>ffmpeg.dll creates an executable memory section and calls the decrypted data, shellcode section.</p>
</li>
<li>
<p>This shellcode resolves apis at runtime, changes memory regions to executable and then calls the appended dll.</p>
</li>
<li>
<p>This new dll has an export of interest called DllGetClassObject, which is called.</p>
</li>
<li>
<p>DllGetClassObject doesn’t directly call the next function but uses CreateThread and passes the function location as the start address.</p>
</li>
<li>
<p>The item to note near the start of this new function is the manifest file.  It looks for and if absent creates a file named manifest.  This file contains a little endian representation of the current timestamp future dated by about a week.  This is important because:</p>
</li>
<li>
<p>It uses this during the file read to enter a while loop that essentially sleeps and waits until the current time matches that stored in the file.  Basically waiting for about a week to execute again.</p>
</li>
<li>
<p>Note: Later, I will talk about patching this to aid in analysis.</p>
</li>
<li>
<p>It next calls out to a github repo to pull down an ICO file.</p>
</li>
<li>
<p>This file has a base64 string appended after the end denoted by a leading dollar sign.</p>
</li>
<li>
<p>This string is two parts to an AES GCM decrypt function.  The first part is used to generate the key and the second part is the encrypted data.</p>
</li>
<li>
<p>After decryption, it is shown to be another url, which is used for a follow-up GET request.</p>
</li>
<li>
<p>Note: Some reports state infostealer malware was the final payload, however it could possibly be any final stage stealer/c2 malware being delivered.</p>
</li>
</ol>
<h1 id="full-analysis">Full Analysis</h1>
<p>Note: I realize there are a lot of pages and screenshots but the purpose would be to provide a detailed map for others to follow on their own.</p>
<p>I started by grabbing what looks to be a more recent version sample of the MSI installer from VT with hash:</p>
<p>0eeb1c0133eb4d571178b2d9d14ce3e9</p>
<p>This was listed on a recent IOC list by sophos labs:</p>
<p><a href="https://www.google.com/url?q=https://github.com/sophoslabs/IoCs/blob/master/3CX%2520IoCs%25202023-03.csv&amp;sa=D&amp;source=editors&amp;ust=1680878844534727&amp;usg=AOvVaw2TteIypNHGBH6a9D30qa8K">https://github.com/sophoslabs/IoCs/blob/master/3CX%20IoCs%202023-03.csv</a></p>
<p>Initially, I used 7zip to extract MSI installer contents for review.  Based on initial reports it was unclear how the malicious dlls were being delivered, however it looks like they were put directly into the MSI installer.  Checking I see the following suspect dlls that were being flagged by other reports:</p>
<p>FFMPEG.dll: 74BC2D0B6680FAA1A5A76B27E5479CBC</p>
<p>D3DCOMPILER.dll: 82187AD3F0C6C225E2FBA0C867280CC9</p>
<p>Initial review of exports shows nothing that stands out “name-wise”.  As this is supposed to be a compromised dll, I performed bindiff operations to compare to what could be a legit version of the dll to help find modified/malicious code.</p>
<p>Due to overall size, the number of functions differs quite a bit.  Instead looking at everything, checked to see what might be calling this as a dependency and what functions it might be calling.</p>
<p>The 64 bit program 3CXDesktopApp.exe, calls ffmpeg as a dependency.  Looking at the symbol references:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image66.png" alt=""></p>
<p>In the ffmpeg namespace, four items are called.  I reviewed each of these and compared them to the legit version without anything standing out.  Checking the entrypoint, you can see a change has been made there.</p>
<p>In a suspected clean previous version, see the highlighted function being called:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image22.png" alt=""></p>
<p>Then looking at that function, it has no actual content except a return:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image59.png" alt=""></p>
<p>In contrast here is the suspected malicious dll:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image77.png" alt=""></p>
<p>And the same function call:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image29.png" alt=""></p>
<p>Except now this function is calling another function before returning.  A quick review of this function shows it only existing in the malicious dll:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image10.png" alt=""></p>
<p>Starting at CreateEventW, you can see its called receiving the default security descriptor (null), bmanualreset (true - must have matching reset event to go nonsignaled), initialstate (nonsignaled) and the name “AVMonitorRefreshEvent”.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image72.png" alt=""></p>
<p>Next GetModuleFileNameW is called with a null handle (look in current process), and get the current full execution path. Then the following function call FUN_1800c157c, returns the calling exe from that same path.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image19.png" alt=""></p>
<p>The string d3compiler_47.dll is moved (eventually to rax) from a static location in the programs rdata section.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image33.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image24.png" alt=""></p>
<p>This dll is then read to memory in a typical CreateFileW, GetFileSize, then ReadFile flow.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image58.png" alt=""></p>
<p>File is requested with GENERIC_READ and a handle is returned.  Then that handle is passed to GetFileSize to be used in the next module.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image14.png" alt=""></p>
<p>Lastly ReadFile is called along with this file handle and the returned size. The second parameter here is the buffer that will hold the result.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image35.png" alt=""></p>
<p>After the call:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image55.png" alt=""></p>
<p>It next looks in that file for the following marker: 0xfe 0xed 0xfa 0xce:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image39.png" alt=""></p>
<p>Here is the full loop looking for this marker:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image53.png" alt=""></p>
<p>It next takes this found data and performs RC4.  </p>
<p>It reads in the key here as “3jB(2bsG#@c7”</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image67.png" alt=""></p>
<p>The initialization of the array for KSA starts here (identified initially by the 0x100 (256) loop:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image20.png" alt=""></p>
<p>The created S-Box can be seen here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image12.png" alt=""></p>
<p>And the rest of the KSA:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image40.png" alt=""></p>
<p>Then the PRGA:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image5.png" alt=""></p>
<p>The XOR operation here will contain the key and the the cipher text to operate on:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image21.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image62.png" alt=""></p>
<p>The RAX register contains the size:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image3.png" alt=""></p>
<p>By looking at the file, it starts decryption right after the second feedface for 0x43B08:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image30.png" alt=""></p>
<p>The start of the encrypted block starts here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image37.png" alt=""></p>
<p>To confirm, this is standard RC4, an example program in python to decrypt this in mass would be:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image64.png" alt=""></p>
<p>Shortly after, VirtualProtect is called on this decrypted data:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image71.png" alt=""></p>
<p>You can see when this is called, the address to operate on is the previously decrypted data, with the same seen size of 0x43B08 and the memory protection option 0x40 (RWX).</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image26.png" alt=""></p>
<p>This call will execute the shellcode at that memory address:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image70.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image79.png" alt=""></p>
<p>The shellcode attempts to load a new dll</p>
<p>To find this, watch for VirtualAlloc with a size of 0x48000</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image23.png" alt=""></p>
<p>Setting a hardware bp at 0x100, you can see the PE header being written.</p>
<p>The shellcode is actually performing loader functionality and nothing else.</p>
<p>The shellcode resolves apis at runtime: <img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image46.png" alt=""></p>
<p>Rbp+3c already holds the dll at this point.</p>
<p>Looking closer at the rc4 decrypted shellcode, the top portion is shellcode 0x65D and everything after that is the loaded dll 0x434AB.</p>
<p>Based on the behavior of the shellcode and the included dll, the shellcode appears to be resolving libraries with the call to 26771BC474 above and leveraging those to execute the next stage dll.  </p>
<p>Here are some tips to help step through with a debugger as CreateThread is called to execute (screenshots to follow):</p>
<p>The shellcode maps the dll to memory, so watch for a virtualprotect at xx1000 (offset 1000, memory), with 0x20, execute/read.  Once that location is found, search that region for the bytes: 48 89 5c 24 08 48 89 6C 24 10.  Should be 11CD0 offset from base.  Set a breakpoint on that location, ex: setbpx 1F824191CD0. We now need to step over/down to the createthread call.  Pause on that call and look for the third param, lpStartAddress.  Grab that address and set another bp.</p>
<p>Run through the virtualprotects/allocs and all of the tls callbacks, then go past the actual entrypoint and the new dll function will run in the new thread.</p>
<p>To continue (and avoid waiting) we need to patch the jge to jle:</p>
<p>Note: I have patched the decrypted dll as shown below, re-encrypted with RC4 and added back to the file d3dcompiler_47.dll.  This will be called as normal and with this patch it won’t wait.  As long as you have a manifest file, it will continue uninterrupted.  I have provided this file zipped and pw protected with “infected” in case anyone else wants to perform analysis easier.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image17.png" alt=""></p>
<p>Status of the stack when the dll export is called:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image49.png" alt=""></p>
<p>Full first line is:</p>
<ul>
<li>rcx 000002109694DD5D &ldquo;1200 2400 \&ldquo;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) 3CXDesktopApp/18.11.1197 Chrome/102.0.5005.167 Electron/19.1.9 Safari/537.36\&rdquo;&rdquo;</li>
</ul>
<p>Localalloc is called to reserve memory space and then multibytetowide is called.  This will copy the user agent string seen, 0xAA in size to the newly allocated memory region.</p>
<p>Note: The use of LocalAlloc seems to be the reason this dll won’t run on its own as you get memory exceptions.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image32.png" alt=""></p>
<p>The pointer being moved to r8 is important here as its setting up for a call to create thread.  Since its being called like this, Ghidra has problems showing the flow,,,however, this is the most important function and part of the malicious flow.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image36.png" alt=""></p>
<p>Now we have that call to createthread.  It will have the default security descriptor, default stack size, the start address is seen in the third parameter (you must set a bp on this location to continue to watch the flow), the variable being passed in is our wide user agent value with two other values on the front being “1200” and “2400”, lastly, the thread is set to run immediately.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image61.png" alt=""></p>
<p>Note: after running from this point (with the bp set), you will hit the normal tls callbacks and entrypoint for the legit exe.  Hitting run one more time from the entry point will get you back to the dll and functions of interest.</p>
<p>_time64 is called in the highlighted function and then the result is passed to the function below</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image16.png" alt=""></p>
<p>This functions purpose looks to be used for storing that returned time to local fiber storage.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image65.png" alt=""></p>
<p>Calloc is called and then flssetvalue is called again.  Adding the new memory region to the same fiber as before with the 0xFFF…</p>
<p>The next cmdline to args returns only the “1200” from the passed input:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image1.png" alt=""></p>
<p>GetModuleFileNameW gets the full working directory and then the function immediately after returns just the calling exe name.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image69.png" alt=""></p>
<p>That function performs some work on the filename and then loads the string “manifest” from file storage, then the following function converts that to a wide string.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image9.png" alt=""></p>
<p>The highlighted function calls _waccess and checks for the existence of the manifest file (zero perm passed as second arg).  If it returns zero (exists), it will attempt to open it.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image41.png" alt=""></p>
<p>An example of a file that as previously written, being read with fread, in:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image48.png" alt=""></p>
<p>In this loop uVar10 is the full value seen above 15 EC 31 64, since this is little endian, the value store in the register is also shown below:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image75.png" alt=""><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image60.png" alt=""></p>
<p>_time64 is called again resulting in the rax register containing the hex value for the epoch time: 1680487004.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image68.png" alt=""></p>
<p>Using this same conversion for the value being read in from the file, it converts to 1680993301, or about 7 days in the future from when it was originally created.  </p>
<p>Note: if the file doesn’t exist, the function FUN_180021440, returns iVar3, in an example was 5F4B, which in this equation, will add 629195 seconds to the current timestamp.  There are 604800 seconds in a week (which is the 0x93A80 below), so it appears that this will add just a little padding.  Running this multiple times shows that function will return similar results, so there is some randomness to it but you will get roughly a week.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image63.png" alt=""></p>
<p>We now enter this while loop, that compares the current time being less than the future dated time.  Essentially, it will sleep for 16 minutes (1000 seconds), update the current time and keep looping.  Seems like a way for this to only run every week and not constantly.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image73.png" alt=""></p>
<p>Next RegOpenKeyExW is called with the registry key  FFFFFFFF80000002 (HKLM), Subkey, &ldquo;Software\\Microsoft\\Cryptography&rdquo; and access rights of 20019, which is key_execute, aka key_read</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image34.png" alt=""></p>
<p>It then reads the MachineGuid value found there: (at this point just to be used as a unique identifier).</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image18.png" alt=""></p>
<p>We have now made it to the function responsible for the internet communication, ending in 1500:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image25.png" alt=""></p>
<p>Going into the initial http request the stack and memory look like:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image15.png" alt=""></p>
<p>We finally have the first outbound call using InternetOpenW, getting ready to use WinInet Functions.  The only parm being passed is the already seen user agent.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image74.png" alt=""></p>
<p>InternetSetOptionsW is now called with the dwOption of 0x41 - or set user agent.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image38.png" alt=""></p>
<p>Note: During these calls, the program seems to jump to the main program, which slows analysis.  Also, trying to run to return doesn’t work in this context either, which also slows things down.</p>
<p>InternetCrackUrlW is being called on the known url to split it up, then the next call is to InternetConnectW. Here it is to the known domain, with the server port as 0x1BB, aka 443 in decimal.  The only other param is the 6th one as 0x3 or dwService being HTTP.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image78.png" alt=""></p>
<p>The next call is to HttpOpenRequestW, the options here are self explanatory. Get request for the ico file.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image57.png" alt=""></p>
<p>Next call is HttpAddRequestHeadersA, basically adding accept: */* to each request.  The \r\n is required for this string value.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image13.png" alt=""></p>
<p>It appears to be using localalloc and then referencing stored string for multiple request header adds as seen in the following screenshots.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image4.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image11.png" alt=""></p>
<p>Next up is HttpSendRequestW, no additional params of note.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image42.png" alt=""></p>
<p>Result:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image28.png" alt=""></p>
<p>InternetReadFile is now called multiple times and goes through the entire received file in chunks.  Right after there is a call to HttpQueryInfoW to check status and then returns after cleanup.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image51.png" alt=""></p>
<p>We then go into a loop that starts at the end of the received file and looks for a $ - Dollar sign.  After that another function is called for decoding.</p>
<p>First it calls CryptStringToBinaryA:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image56.png" alt=""></p>
<p>A typical AES decrypt is setup with following functions.  BcryptOpenAlgorithmProvider (AES), BcryptSetProperty (GCM), BcryptGenerateSymmetricKey.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image52.png" alt=""></p>
<p>The most interesting part being the secret key here.  More specifically param 5 and 6, key and keysize.  The keysize is 0x20 and the key here is:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image45.png" alt=""></p>
<p>Key:  21A1ACE1E663BA45864DF457B209181EBD90101B4A512840387CD210E58FA3F1</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image31.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image8.png" alt=""></p>
<p>Data to be decrypted:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image50.png" alt=""></p>
<p>This data is part of the decoded base64.  The first 40 chars (20 hex bytes) are not part of the encrypted data and are used for something else which will be discussed later.</p>
<p>Additional data: (20 bytes) 29000000a3beb473640109dfc423f982b7c6db57</p>
<p>Data to decrypt: (90 bytes here): a4c105b385aeacc50aedcc5a37a0f49e90ce2ad17db8fac2a2bf4dbe08c8608c6b0711f7fee341a296a6a9eb8007a9af35ea1ce282f667b31077df105969d249de1195d9dd722063204954624948651e4f5fc02567c02b523757</p>
<p>Other notes about this is, there is no IV param, however this is because its AES GCM the IV or Nonce are passed in another way.</p>
<p>The second call to bcryptdecrypt has an actual pboutput location.  The first call included a nullptr for output with the purpose of determining output buffer size.  Hence the localAlloc call directly after.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image54.png" alt=""></p>
<p>Which has the result:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image2.png" alt=""></p>
<p>One very important part, since this is AES GCM, is to look at the “paddingInfo” param when BCryptDecrypt is called.  This will not contain padding but BCRYPT_AUTHENTICATED_CIPHER_MODE_INFO structure.  This structure is documented my MS but a little harder to read when looking at the complete block like this:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image76.png" alt=""></p>
<p>Essentially, you are looking at each section of this block as a little endian value.  For example, the size is the first four bytes as 58 00 00 00, or 0x58 after converting from little endian.  The full parsed values are:</p>
<p>cbSize=0x00000058 = Total size after the size and info sections.</p>
<p>dwInfoVersion=0x00000001 = version 1</p>
<p>pbNonce=0x00000061827FE2E0 = In place of the IV param, the Nonce is used here, this is a memory location not the actual value.</p>
<p>cbNonce=0x0000000C = At the previous memory location, the nonce is 0xC is length.</p>
<p>pbAuthData=0x0000000000000000 = Not used</p>
<p>cbAuthData=0x00000000 = Not used</p>
<p>pbTag=0x000001FB2EC46F44 = This is also a pointer to a memory location where the tag is stored.</p>
<p>cbTag=0x00000010 = Again, at that location the tag is 0x10 in length.</p>
<p>Following the Nonce location we can see its - 3B8A08ED0F9E08CA572109EF</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image27.png" alt=""></p>
<p>Then our Tag here as - A3BEB473640109DFC423F982B7C6DB57</p>
<p>Which should look familiar as this is included as part of the b64 value appended to the ICO file.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image44.png" alt=""></p>
<p>With the key, nonce and tag, we can decrypt the data outside of this program.  See the c++ code in this same section for an example on how to decrypt with AES GCM and the MS BCrypt library.  The values here are hardcoded, however could be easily updated for future samples/uses.</p>
<p>As a final step, it turns around and requests that url via a get:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image7.png" alt=""></p>
<p>Unsure of exact content of this next payload at this time but articles suggest an infostealer is related.</p>
<p>As for other actions this would take if a response was returned:</p>
<p>Right after this follow up response we see similar calls to the same AES decrypt routine as well as calls to virtualprotect (as expected):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image47.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/3cx/image43.png" alt=""></p>
<h1 id="tools-created-as-a-result">Tools Created as a Result</h1>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Description</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>d3dcompiler_patched.7z</td>
<td>Patched version to skip manifest wait.</td>
<td><a href="https://github.com/xd43D41U5x/Analysis/blob/master/3CX/d3dcompiler_patched.7z">Link</a></td>
</tr>
<tr>
<td>decrypt.cpp</td>
<td>BCrypt AES GCM Decrypt Example</td>
<td><a href="https://github.com/xd43D41U5x/Analysis/blob/master/3CX/decrypt.cpp">Link</a></td>
</tr>
<tr>
<td>rc4Decrypt.py</td>
<td>RC4 Decrypt/Encrypt used for patching</td>
<td><a href="https://github.com/xd43D41U5x/Analysis/blob/master/3CX/rc4Decrypt.py">Link</a></td>
</tr>
<tr>
<td>bCryptCipherInfoParser.py</td>
<td>Parser for Cipher Info Struct</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/bCryptCipherInfoParser.py">Link</a></td>
</tr>
</tbody>
</table>
<h1 id="file-hashes">File Hashes</h1>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
<th>Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>3CXDesktopApp-18.12.416.msi</td>
<td>3CX Installer</td>
<td>0eeb1c0133eb4d571178b2d9d14ce3e9</td>
</tr>
<tr>
<td>ffmpeg.dll</td>
<td>Compromised Dll</td>
<td>74BC2D0B6680FAA1A5A76B27E5479CBC</td>
</tr>
<tr>
<td>d3dcompiler_47.dll</td>
<td>Encrypted content in overlay</td>
<td>82187AD3F0C6C225E2FBA0C867280CC9</td>
</tr>
<tr>
<td>decrypted dll</td>
<td>Decrypted and final stage dll</td>
<td>CA5A66380563CA4C545F1676C23BD95D</td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#summary">Summary</a>
      <ul>
        <li><a href="#physical-files-involved">Physical Files Involved</a></li>
        <li><a href="#execution-flow">Execution Flow</a></li>
      </ul>
    </li>
    <li><a href="#full-analysis">Full Analysis</a></li>
    <li><a href="#tools-created-as-a-result">Tools Created as a Result</a></li>
    <li><a href="#file-hashes">File Hashes</a></li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
