<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Malicious Chrome Ext</title>
    <meta name="description" content="Review of a Malicious Chrome Ext Using Stego">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/stegochrome/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Malicious Chrome Ext">
    <meta property="og:description" content="Review of a Malicious Chrome Ext Using Stego">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Malicious Chrome Ext">
    <meta name="twitter:description" content="Review of a Malicious Chrome Ext Using Stego">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/stegochrome/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/stegochrome/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/stegochrome/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Malicious Chrome Ext</h1>
        <small role="doc-subtitle">Review of a Malicious Chrome Ext Using Stego</small>
        <p class="post-date">
            August 25, 2022
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="analysis">Analysis</h1>
<p>To start, we will only be looking at the two files of interest and not the whole thing (background.js and promo.jpg).  By looking in background.js, there is an area that stands out, with a variable named “Promo” and a function defined/called there.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image12.png" alt=""></p>
<p>A couple of notes before digging into how this works.</p>
<ol>
<li>
<p>It&rsquo;s referencing a jpg file (really a png) and it&rsquo;s drawing/loading that image.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image2.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image6.png" alt=""></p>
</li>
<li>
<p>So at some point we will realize this is a requirement and since VSCode uses Node.js, we will be missing all of this “window” interaction and won’t be able to run this there.</p>
</li>
<li>
<p>Because of the image requirement, it will not run correctly just by creating an html file with “script” and opening.  This is because of CORS, which blocks cross-origin loading of local files like the jpg we need.  To get around this, use the python simple http server.  Since I’m using python 3, the command is: “python -m http.server 80”.  Running this from the path of our html file (containing the promo js) and the jpg, we can hit this in our browser with “http://localhost/file.html”.</p>
</li>
</ol>
<p>Now that we can load the content, we can use Chrome Devtools to set break points and step through this JS to understand how it&rsquo;s working a bit better.  Due to the size, I’ll break this up into sections from the top/down and then show a cleaned up, reduced version that still works but is easier to read.  In the images below, see my notes on the right in pink.</p>
<p>Original w/notes:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image3.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image5.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image13.png" alt=""></p>
<p>From the notes above, we can now see that “promo” is loading the jpg image and reading the actual pixel rgb values.  It takes those values and does the following:</p>
<ol>
<li>
<p>Re-sizes</p>
</li>
<li>
<p>Math to shift/subtract values</p>
</li>
<li>
<p>Two rounds of decoding</p>
</li>
<li>
<p>Round one is bitwise shifts and charcode math.</p>
</li>
<li>
<p>Round two is less complex as its normal number shifting and char decoding.</p>
</li>
</ol>
<p>The reduced code will be provided but here is a copy with notes as code comments:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image11.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image7.png" alt=""></p>
<p>You can see now that “n” or the renamed variable “finalDecodedValue” is what we want:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image4.png" alt=""></p>
<p>Before even formatting we can see some visible strings:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image1.png" alt=""></p>
<p>Formatted, this is about 200 lines, which is a lot to list here, so I’ll just call out some things we have seen before and key areas/how it works.</p>
<p>Basically, just the variable names and formatting looks like obfuscator io, but maybe an older less complex version as fr4k is missing some key information to work correctly on this simpler style.</p>
<p>This looks like a stacked string list:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image8.png" alt=""></p>
<p>Here is our re-order string shift function, which unlike new versions doesn’t have stop logic built in but only a fixed starting countdown value:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image9.png" alt=""></p>
<p>Main string lookup function, which doesn’t actually perform any “shifting” but its just doing the number conversion and lookups:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image10.png" alt=""></p>
<p>Everything else is something that needs decoded.  We can do this two different ways and I initially updated fr4k but really, this older simpler way isn’t something I would expect to see often and probably isn’t worth the added complexity.  Lets just make a quick script to handle this one off.</p>
<p>A link to the script to do this deob will be included at the end and it includes a lot of comments but to summarize here is:</p>
<ol>
<li>Shift the strings the required number of times.</li>
<li>Identify the main string lookup function name.</li>
<li>Perform the lookups</li>
<li>Replace the lookup call with the correct string.</li>
<li>Cleanup the old function lookups</li>
<li>Convert any remaining hex strings</li>
<li>Convert any remaining hex numbers</li>
<li>Write out the clean result</li>
</ol>
<p>Here are a few of the items we need to know from the actual script (once we know that the rest is just regex/replace and string lookups:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image14.png" alt=""></p>
<p>As is with any of these, the top portion with the strings and lookup functions can be stripped out and you are left with much easier to read and follow code.  It’s still mildly obfuscated but the rest can be cleaned up by hand.  The most important part is the url, which is now easy to see where its called:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/chromeStego/image15.png" alt=""></p>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Description</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>simpleFr4k.py</td>
<td>Stripped down version for this sample</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/simpleFr4k.py">Link</a></td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2024 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
