<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Zloader</title>
    <meta name="description" content="Zloader Deob Review">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/zloader/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Zloader">
    <meta property="og:description" content="Zloader Deob Review">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Zloader">
    <meta name="twitter:description" content="Zloader Deob Review">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/zloader/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/zloader/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/zloader/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Zloader</h1>
        <small role="doc-subtitle">Zloader Deob Review</small>
        <p class="post-date">
            February 8, 2024
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h2 id="scope">Scope</h2>
<p>This review of Zloader will focus on deobfucation and scripts to support that.  There are already other write-ups reviewing overall functionality, IOCs, etc and re-doing that would be no value added.</p>
<h2 id="api-hashing">API Hashing</h2>
<p>To help find the api hashing function, we can look at frequency of calls using the symbol reference table.  Since this will have to be called many times it will likely be one of the top results and in this case it is the topmost at 243:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image24.png" alt=""></p>
<p>Then following the parameters through a few other functions that do not have an effect on the value, you finally end up at the main hasing function that starts at 0x2116a836a20.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image26.png" alt=""></p>
<p>Decompiled view of the hashing loop:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image5.png" alt=""></p>
<p>Start of this as seen in x64dbg:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image2.png" alt=""></p>
<p>As for the algorithm used, it really doesn’t vary from other articles, however, I didn’t compact it in this example so that if something does change in the future, it would be possible to easily update to match.  Also, if you wanted to work it out, this would be an easy way to check each step.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image18.png" alt=""></p>
<p>Notice the xor in the return statement as the value here is constant and most likely to change between samples.  </p>
<p>We can see this in the decompiled view:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image20.png" alt=""></p>
<p>And is the third parameter passed in:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image14.png" alt=""></p>
<p>By looking at references to this main hashing function, there is only one unconditional call.  Checking that call, you can see a stored static value here, which is our xor key:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image31.png" alt=""></p>
<p>Since knowing these values will help analyze this sample, we can use the same method to hash all of the apis on the machine, then create a ghidara script to find the hashes and look them up in the output from our hash list.</p>
<p>There will be links to the actual scripts at the end but just to review what we are doing:</p>
<p>Basically go through and get all of the hash names, then send them to the function noted above:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image16.png" alt=""></p>
<p>We then write the name and hash to a json file to be used in the next step.  You can also uncomment the print statement and write them to the console or redirect the output to a file there.</p>
<p>Normal:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image39.png" alt=""></p>
<p>Json:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image15.png" alt=""></p>
<p>Now for the Ghidra script:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image30.png" alt=""></p>
<p>Process:</p>
<ul>
<li>
<p>Read in json output file and convert it to a dictionary.</p>
</li>
<li>
<p>Get all references to the hashing function, 0x2116a82bd60.</p>
</li>
<li>
<p>Go through those references and get the instruction before them.</p>
<ul>
<li>We are doing that because the hash value is pushed onto the stack right before the function call as it is the second parameter needed.</li>
</ul>
</li>
<li>
<p>We now take those values look them up in the hash dictionary as the key and return the value listed.</p>
</li>
<li>
<p>Now we set a comment and bookmark.</p>
</li>
<li>
<p>Lastly, we write out these to a file.</p>
</li>
</ul>
<p>This will be written to the console:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image35.png" alt=""></p>
<p>But much more usefully as bookmarks, which can be sorted by looking for the string “apihash”:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image34.png" alt=""></p>
<p>Then looking at the code you can see a pre comment to help speed up analysis:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image3.png" alt=""></p>
<p>As noted with this malware, the hashing function contains a lot of dead code to slow down reversing:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image38.png" alt=""></p>
<p>All operate similarly but here is a smaller example which is just performing an OR.  The two parameters are either part of one operation at the very beginning or in the return statement with dead code in between.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image11.png" alt=""></p>
<p>Results of all api’s:</p>
<pre tabindex="0"><code>2116a826e3f,0x5109238c,GetModuleFileNameW

2116a82700d,0x582f0db0,ExitProcess

2116a821466,0x55434b76,LoadLibraryA

2116a821483,0x547a9e11,ExitThread

2116a8214db,0x547a9e11,ExitThread

2116a823cfb,0x55434b76,LoadLibraryA

2116a822b8a,0x5489e5e2,ReadFile

2116a822bea,0x54404412,CloseHandle

2116a82f615,0x5448b59d,VirtualAllocEx

2116a8336e5,0x510f7fec,CreateProcessW

2116a833783,0x54404412,CloseHandle

2116a82e1e5,0x545b880c,RtlInitUnicodeString

2116a82e2b5,0x545b880c,RtlInitUnicodeString

2116a82e364,0x53d7de2d,RtlCreateProcessParametersEx

2116a82e5e6,0x54404412,CloseHandle

2116a835ad1,0x5ede03b5,GetProcessHeap

2116a835ca2,0x51de593d,VirtualProtectEx

2116a82fc61,0x55434b76,LoadLibraryA

2116a82fd68,0x53dca250,GetProcAddress

2116a833afe,0x57ef6781,VirtualProtect

2116a83a062,0x5e56ef51,SetThreadContext

2116a83a412,0x5e57af51,GetThreadContext

2116a82f6ff,0x54959af2,HeapFree

2116a838127,0x590c9ca0,HeapReAlloc

2116a82155b,0x5eb94335,Sleep

2116a834498,0x5702f24c,CreateFileW

2116a834531,0x517abde2,WriteFile

2116a834563,0x54404412,CloseHandle

2116a827482,0x52f00f86,CryptAcquireContextA

2116a8274d1,0x5613502d,CryptCreateHash

2116a82752e,0x50e2a786,CryptHashData

2116a827563,0x5f873cfa,CryptGetHashParam

2116a8275b2,0x5023af5d,CryptDestroyHash

2116a8275cf,0x5301d0f1,CryptReleaseContext

2116a8292dd,0x5c53efe7,MultiByteToWideChar

2116a83af85,0x5317342b,OpenProcessToken

2116a83afb4,0x5f425fdb,GetTokenInformation

2116a83afe3,0x53b070a7,GetLastError

2116a83b045,0x5f425fdb,GetTokenInformation

2116a83b08b,0x517248c1,GetSidSubAuthorityCount

2116a83b0cf,0x5954f97e,GetSidSubAuthority

2116a83b10f,0x54404412,CloseHandle

2116a825822,0x5507f39c,GetFileAttributesW

2116a821dbd,0x59f210d1,GetLengthSid

2116a829351,0x5109238c,GetModuleFileNameW

2116a8293a4,0x5efcfc3c,SHGetFolderPathW

2116a82a994,0x57720b45,WSAStartup

2116a837542,0x5a3e6227,StringFromGUID2

2116a8384e1,0x5317342b,OpenProcessToken

2116a838541,0x5f425fdb,GetTokenInformation

2116a83858b,0x54404412,CloseHandle

2116a830a7d,0x5f425fdb,GetTokenInformation

2116a839d2e,0x5cc7bc96,InternetSetOptionA

2116a83a6da,0x5a58df27,InitializeSecurityDescriptor

2116a83a75c,0x5193f06c,ConvertStringSecurityDescriptorToSecurityDescriptorW

2116a83a7a8,0x58f48429,GetSecurityDescriptorSacl

2116a83a7ea,0x5cf48439,SetSecurityDescriptorSacl

2116a83e1d5,0x50dda226,GetModuleHandleA

2116a83e2af,0x5aafd9ac,GetVersionExW

2116a83e312,0x54530204,GetNativeSystemInfo

2116a83f2dd,0x5308fa4d,ReleaseMutex

2116a83f2f7,0x54404412,CloseHandle

2116a830261,0x5322ad21,GetTickCount

2116a8410ac,0x5eb94335,Sleep

2116a828660,0x5447f39c,SetFileAttributesW

2116a828680,0x5702398c,DeleteFileW

2116a827cae,0x571d2d22,WideCharToMultiByte

2116a8272b9,0x5bd88d72,gethostbyname

2116a82b2f5,0x56365616,CryptStringToBinaryA

2116a82b374,0x5a0132ad,CryptDecodeObjectEx

2116a82b4c5,0x51412071,CryptEncrypt

2116a82b559,0x5301d0f1,CryptReleaseContext

2116a82b57c,0x5691cc62,LocalFree

2116a82fe41,0x525964e2,GetLocalTime

2116a82fe6b,0x5349d412,SystemTimeToFileTime

2116a83471f,0x597c425c,RegCreateKeyExW

2116a83479e,0x53124dac,RegSetValueExW

2116a8347e1,0x5cef45ae,RegCloseKey

2116a836868,0x514c65c6,CreateMutexA

2116a8368f1,0x54404412,CloseHandle

2116a837f79,0x5b46e46c,RegOpenKeyExW

2116a837fca,0x5c64070c,RegQueryValueExW

2116a83804c,0x5c64070c,RegQueryValueExW

2116a8380ad,0x5cef45ae,RegCloseKey

2116a83d7c6,0x51450201,WaitForSingleObject

2116a83d9d0,0x50e5fc62,InternetCloseHandle

2116a831fc4,0x51e53156,InternetCrackUrlA

2116a8388f1,0x53cbbec6,HttpOpenRequestA

2116a838985,0x55689506,InternetQueryOptionA

2116a8389ce,0x5cc7bc96,InternetSetOptionA

2116a838a27,0x531530c6,HttpSendRequestA

2116a838a8c,0x5ca91b96,HttpQueryInfoA

2116a838b14,0x50e5fc62,InternetCloseHandle

2116a83b398,0x5702f24c,CreateFileW

2116a83b4cc,0x5e94d110,FlushFileBuffers

2116a83b4ff,0x517abde2,WriteFile

2116a83b56b,0x54404412,CloseHandle

2116a83d531,0x51450201,WaitForSingleObject

2116a83ed54,0x51b16c40,IsWow64Process

2116a83f41f,0x55689506,InternetQueryOptionA

2116a83f44c,0x50e5fc62,InternetCloseHandle

2116a83f537,0x5a0cbac6,InternetOpenA

2116a83f5c0,0x5cc7bc96,InternetSetOptionA

2116a83f618,0x5e24bd06,InternetConnectA

2116a83f671,0x50e5fc62,InternetCloseHandle

2116a829424,0x57ff9555,WSACleanup

2116a829c45,0x585dd3ed,SetFilePointerEx

2116a827903,0x55f9b201,Wow64SetThreadContext

2116a82e794,0x50dda226,GetModuleHandleA

2116a82e7c9,0x53dca250,GetProcAddress

2116a82e835,0x5e56ef51,SetThreadContext

2116a82bd13,0x51e98471,CreateThread

2116a822141,0x5a621c7c,OpenSCManagerW

2116a822294,0x581db9a2,CloseServiceHandle

2116a8222b4,0x581db9a2,CloseServiceHandle

2116a822657,0x58c4d4dc,wvnsprintfW

2116a831b3c,0x54404412,CloseHandle

2116a832e13,0x53fdde5c,WSAStringToAddressW

2116a832e68,0x53fdde5c,WSAStringToAddressW

2116a835c03,0x5c90d7ac,PathCombineW

2116a837985,0x5702f24c,CreateFileW

2116a83c7ba,0x54404412,CloseHandle

2116a821fd7,0x58c4d4a6,wvnsprintfA

2116a84232e,0x54404412,CloseHandle

2116a8425b0,0x557e9b41,ResetEvent

2116a8437fd,0x58c4d4dc,wvnsprintfW

2116a842f74,0x58c4d4a6,wvnsprintfA

2116a843149,0x51450201,WaitForSingleObject

2116a82d729,0x58cd01a2,TranslateMessage

2116a82d73e,0x5005268c,DispatchMessageW

2116a82d750,0x5c14fce1,GetTickCount64

2116a82d775,0x5eb94335,Sleep

2116a821e85,0x50dda23c,GetModuleHandleW

2116a821ea9,0x53bebcc6,RegisterClassA

2116a821ebb,0x50dda23c,GetModuleHandleW

2116a821eec,0x573c67f6,CreateWindowExA

2116a8288b5,0x582f0db0,ExitProcess

2116a8288e1,0x582f0db0,ExitProcess

2116a828a97,0x582f0db0,ExitProcess

2116a8244d6,0x54404412,CloseHandle

2116a828589,0x5405e81b,Wow64EnableWow64FsRedirection

2116a8290d1,0x5005b8c1,ResumeThread

2116a82a9ec,0x5702f24c,CreateFileW

2116a82aa86,0x59d61c6d,GetFileSizeEx

2116a82ab3c,0x5489e5e2,ReadFile

2116a82bf28,0x5495c97c,PathFindFileNameW

2116a82574f,0x5eaefcc0,htons

2116a8286e8,0x5cd48b3c,GetComputerNameW

2116a828719,0x512880bc,GetUserNameW

2116a82d630,0x54404412,CloseHandle

2116a82d666,0x54404412,CloseHandle

2116a830cd6,0x578c923c,PathRemoveExtensionW

2116a827aad,0x51207fa2,SetEndOfFile

2116a831cc2,0x5b46e46c,RegOpenKeyExW

2116a831d6a,0x5cef45ae,RegCloseKey

2116a832c0f,0x59c681ec,PathFindExtensionW

2116a833806,0x585dd3ed,SetFilePointerEx

2116a8358a9,0x5507f39c,GetFileAttributesW

2116a835dbd,0x5489e5e2,ReadFile

2116a835e5a,0x5836fcf1,GetOverlappedResult

2116a835e85,0x53b070a7,GetLastError

2116a836983,0x517abde2,WriteFile

2116a8369b5,0x53b070a7,GetLastError

2116a8369da,0x5836fcf1,GetOverlappedResult

2116a836feb,0x5702f24c,CreateFileW

2116a83707d,0x517abde2,WriteFile

2116a83cb7d,0x54aa6682,VirtualFree

2116a83df3a,0x5193f06c,ConvertStringSecurityDescriptorToSecurityDescriptorW

2116a83df73,0x58f48429,GetSecurityDescriptorSacl

2116a83dfaf,0x5691a03c,SetNamedSecurityInfoW

2116a83dffb,0x5691cc62,LocalFree

2116a8362f5,0x53045bdb,OpenThreadToken

2116a83631b,0x5317342b,OpenProcessToken

2116a836389,0x5ff15ddc,LookupPrivilegeValueW

2116a8363bc,0x553c7e30,AdjustTokenPrivileges

2116a8363f1,0x53b070a7,GetLastError

2116a836410,0x54404412,CloseHandle

2116a83fd0c,0x51e98471,CreateThread

2116a831839,0x597343c6,StrCmpNIA

2116a83cd2f,0x597343c6,StrCmpNIA

2116a8330f0,0x5eaefcc0,htons

2116a833121,0x570b3324,getaddrinfo

2116a8331ee,0x53800024,freeaddrinfo

2116a8236f2,0x5b74c931,socket

2116a823757,0x57b46351,connect

2116a823781,0x553decb1,closesocket

2116a834cdd,0x5b805901,CreateToolhelp32Snapshot

2116a834d34,0x5dd411dc,Process32FirstW

2116a834d7b,0x51ab5b3c,Process32NextW

2116a838fde,0x5d7879fc,WSAAddressToStringW

2116a839611,0x50dda226,GetModuleHandleA

2116a83b9a5,0x5b805901,CreateToolhelp32Snapshot

2116a83b9c6,0x5dd411dc,Process32FirstW

2116a83b9f7,0x51ab5b3c,Process32NextW

2116a83ca53,0x561ca52c,ExpandEnvironmentStringsW

2116a83f791,0x5bc95b72,GetSystemTime
</code></pre><h2 id="string-deob">String Deob</h2>
<p>Now for the strings.  Since we know that the strings are encrypted here, we can use the same method to try and find the decrypt function by looking for a large number of calls.</p>
<p>After spot checking a few, this one was identified:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image40.png" alt=""></p>
<p>This looks like standard xor decrypt function and in this case param1 is the input and param2 is the output.  The key is 0x11 bytes long, the dat value is likely our static key and it runs until it hits an ‘\0’ (null).</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image10.png" alt=""></p>
<p>Here is the key:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image21.png" alt=""></p>
<p>Testing a few ad-hoc shows this is correct.  Now to script it.</p>
<p>Now, since this is stored in the file’s rdata section, we could technically read that in with an external program, xor with the known key and split on the null terminated strings.  However, I wanted to do this with Ghidra scripting so I could add bookmarks and comments to help with code analysis but also in the event it changes and they no longer have a clear separator, this would be a better way to parse.</p>
<p>Let’s take a look at each part of the script:</p>
<p>Standard Xor script takes and returns a byte array:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image1.png" alt=""></p>
<p>Get the high functions then return the decompiled C code as well as the local symbols for the given function.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image29.png" alt=""></p>
<p>Get the calling function name for the given address and add those unique values to a list that is returned.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image17.png" alt=""></p>
<p>A way to set comments and bookmarks from our final decrypted results dictionary.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image9.png" alt=""></p>
<p>The function creating the items and calling xor decrypt.  <img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image8.png" alt=""></p>
<p>A few notes about this function and why this ended up being more of a pain then just doing the api hashing.</p>
<p>Take this example:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image28.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image7.png" alt=""></p>
<p>So we can find the function call and then step backwards to grab the dat value.  Since these are stored as bytes, the “getBytes” call we need to use requires a “size” value.  You can’t tell what size this is without looking at the local variables.  The good news is that you can grab this information by calling “getLocalSymbolsMap” and then “getSymbols”.  The bad news is that this maps to local_19 in this example.  The problem is local_19 is a label added by the decompiler and is never actually “set” to a value in this context.  Which breaks any normal way to grab this info.</p>
<p>The way I got this sorted was to dump the entire function’s C style code, use regex to find the xor function calls and then add that Dat value and the local variable to a dictionary.  I then iterate through the local symbol list matching the symbol to the variable, then grab the size from that mapping.  Now with this size and Dat position, we can grab that data and turn around and send it to the xor decrypt function.  This is appended to a new dictionary that is returned for future use.</p>
<p>It was listed earlier but this dictionary is sent to the set comments and bookmarks function to go through all of the references, match the Dat value and then use the decrypted string in that location.</p>
<p>Finally the main part of this script calling the previously mentioned functions and then writing out the result to a file as well.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image33.png" alt=""></p>
<p>The file output looks like this:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image41.png" alt=""></p>
<p>There were a couple of items that didn’t decode with this method, however I converted those to a hex string and still wrote them out so we wouldn’t lose that data.  There was only a few of these and can be hex decoded if needed.</p>
<p>The final list:</p>
<pre tabindex="0"><code>    &#34;2116a844172&#34;: &#34;advapi32.dll&#34;,

    &#34;2116a844050&#34;: &#34;NtCreateThreadEx&#34;,

    &#34;2116a844210&#34;: &#34;NtSetContextThread&#34;,

    &#34;2116a844330&#34;: &#34;C&#34;,

    &#34;2116a844770&#34;: &#34;RtlUserThreadStart&#34;,

    &#34;2116a844010&#34;: &#34;kernel32.dll&#34;,

    &#34;2116a844654&#34;: &#34;GET&#34;,

    &#34;2116a8445ca&#34;: &#34;wins&#34;,

    &#34;2116a84408a&#34;: &#34;ole32.dll&#34;,

    &#34;2116a844658&#34;: &#34;Global\\\\&#34;,

    &#34;2116a844848&#34;: &#34;psapi.dll&#34;,

    &#34;2116a844606&#34;: &#34;dxgi.dll&#34;,

    &#34;2116a844528&#34;: &#34;\*/\*&#34;,

    &#34;2116a84407b&#34;: &#34;POST&#34;,

    &#34;2116a84403e&#34;: &#34;user32.dll&#34;,

    &#34;2116a8443d0&#34;: &#34;Connection: close\\r\\n&#34;,

    &#34;2116a8446f4&#34;: &#34;NtResume&#34;,

    &#34;2116a8447d0&#34;: &#34;NtAllocate&#34;,

    &#34;2116a844184&#34;: &#34;ncrypt.dll&#34;,

    &#34;2116a844c5c&#34;: &#34;shell32.dll&#34;,

    &#34;2116a84460f&#34;: &#34;cabinet.dll&#34;,

    &#34;2116a844381&#34;: &#34;wldap32.dll&#34;,

    &#34;2116a844420&#34;: &#34;bcrypt.dll&#34;,

    &#34;2116a844585&#34;: &#34;winscard.dll&#34;,

    &#34;2116a844540&#34;: &#34;NtWriteVirtualMemory&#34;,

    &#34;2116a844660&#34;: &#34;Security Metrics&#34;,

    &#34;2116a844149&#34;: &#34;rpcrt4.dll&#34;,

    &#34;2116a844027&#34;: &#34;secur32.dll&#34;,

    &#34;2116a844223&#34;: &#34;ws2\_32.dll&#34;,

    &#34;2116a8440c0&#34;: &#34;bcdfghklmnpqrstvwxz&#34;,

    &#34;2116a8443e4&#34;: &#34;HTTP/1.1&#34;,

    &#34;2116a8441a3&#34;: &#34;urlmon.dll&#34;,

    &#34;2116a8447e8&#34;: &#34;\_ThreadS&#34;,

    &#34;2116a844c68&#34;: &#34;wininet.dll&#34;,

    &#34;2116a844790&#34;: &#34;NtCreateUserProcess&#34;,

    &#34;2116a844592&#34;: &#34;MSIMG32.dll&#34;,

    &#34;2116a844350&#34;: &#34;Software\\\\Microsoft\\\\&#34;,

    &#34;2116a844033&#34;: &#34;ftllib.dll&#34;,

    &#34;2116a844230&#34;: &#34;NtProtectVirtualMemory&#34;,

    &#34;2116a844158&#34;: &#34;ThreadStart&#34;,

    &#34;2116a8443aa&#34;: &#34;samlib.dll&#34;,

    &#34;2116a844674&#34;: &#34;netapi32.dll&#34;,

    &#34;2116a844832&#34;: &#34;gdiplus.dll&#34;,

    &#34;2116a844706&#34;: &#34;wtsapi32.dll&#34;,

    &#34;2116a844628&#34;: &#34;mpr.dll&#34;,

    &#34;2116a84413c&#34;: &#34;iphlpapi.dll&#34;,

    &#34;2116a84417f&#34;: &#34;.com&#34;,

    &#34;2116a8443b5&#34;: &#34;shlwapi.dll&#34;,

    &#34;2116a84401d&#34;: &#34;post.php&#34;,

    &#34;2116a84457e&#34;: &#34;Local\\\\&#34;,

    &#34;2116a844190&#34;: &#34;NtGetContextThread&#34;,

    &#34;2116a8447f7&#34;: &#34;dnsapi.dll&#34;,

    &#34;2116a84461b&#34;: &#34;imagehlp.dll&#34;,

    &#34;2116a844760&#34;: &#34;NtOpenPr&#34;,

    &#34;2116a844164&#34;: &#34;RtlGetVersion&#34;,

    &#34;2116a844247&#34;: &#34;userenv.dll&#34;,

    &#34;2116a844802&#34;: &#34;crypt32.dll&#34;,

    &#34;2116a844648&#34;: &#34;versi&#34;,

    &#34;2116a8447bc&#34;: &#34;gdi32.dll&#34;,

    &#34;2116a8442a5&#34;: &#34;aeiouy&#34;,

    &#34;2116a8447c6&#34;: &#34;https://&#34;,

    &#34;2116a844080&#34;: &#34;ntdll.dll&#34;
</code></pre><p>Example of created bookmarks:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image37.png" alt=""></p>
<p>Example of added comments:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image32.png" alt=""></p>
<h2 id="config">Config</h2>
<p>Another item we can quickly review is the config.  There is a long hard coded string visible in this sample:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image36.png" alt=""></p>
<p>Which is referenced here: (function names updated to help see what is going on)</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image13.png" alt=""></p>
<p>So basically, we are calling the decrypt with the key, key length, data and data size.  You can also find this function by searching text for 0x100, which you will see in the sbox creation as well as other following steps during rc4 decryption and then walk it back to this function by looking at references.</p>
<p>Since we want to find what param1 is, we need to look at the function right before the call to rc4.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image23.png" alt=""></p>
<p>You can see that it is copying param2 (our Dat value) to param1 (our encrypted content) for the length of param3.<img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image6.png" alt=""></p>
<p>So all we need to do is grab 0x3fc bytes at the dat location:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image27.png" alt=""></p>
<p>No fancy scripts needed here, I just snagged this encrypted data with a hex editor and along with the key decrypted in cyberchef:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image22.png" alt=""></p>
<h2 id="dga">DGA</h2>
<p>Just for fun, one last item we can touch on is the way this malware resorts to DGA when it can’t contact the main c2.  By searching for the previously decoded “.com” string, you can follow that back to a function that is performing this generation.  By looking at references to that, you can see a call right before to this function:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image4.png" alt=""></p>
<p>Since we have all of our api’s labeled now, it is easy to see that it calls getlocaltime, then systemtimetofiletime.  Which will give you a Win32 FileTime value such as: 133517884190000000.  There is a call right before it returns at 20e80ea21a0:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image12.png" alt=""></p>
<p>I marked one function it contains with a comment here but as is with everything else this sample does, it doesn’t just perform a division.  It calls a function filled with junk/dead code to xor the param passed in with a static value to just return 10000000.  In that function there are about 50 lines of code and a call to another function with another 30ish to just do this one operation here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image25.png" alt=""></p>
<p>So the goal of these math operations before being returned is to convert the Win32 value to Epoch time.</p>
<p>The generation function starts on: 20e80e9a840 and begins with an epoch time with the seconds zero’d to give the start of the day value (midnight utc).</p>
<p>EAX when entering this function for example could be: 0000000065C2C800, which converts to 1707264000, Wednesday, February 7, 2024 12:00:00 AM.</p>
<p>In this while loop, there is a for loop that runs until 0x14, so this will be generating domains 20 chars in length and this will generate 0x20 (32) each day.</p>
<p>The time value is the seed to the generator here.  See this Python script that mimics the actions to show the steps taken:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image42.png" alt=""></p>
<p>The domains for the day I ran this were:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/zloader/image19.png" alt=""></p>
<hr>
<h1 id="sample-hashes">Sample Hashes </h1>
<table>
<thead>
<tr>
<th>Description</th>
<th>MD5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Zloader</td>
<td>a58aaa24f417bee90ff01865d81866c5</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="tools">Tools</h1>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Description</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>apiHashToGhidra.py</td>
<td>Generate hash list</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/apiHashToGhidra.py">LINK</a></td>
</tr>
<tr>
<td>ghidraApiHashLookup.py</td>
<td>Ghidra Script for API Hash deob</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/ghidraApiHashLookup.py">LINK</a></td>
</tr>
<tr>
<td>ghidraZloaderStrings.py</td>
<td>Ghidra Script for String Deob</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/ghidraZloaderStrings.py">LINK</a></td>
</tr>
<tr>
<td>zloaderDGA.py</td>
<td>DGA Generator Script</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/zloaderDGA.py">LINK</a></td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2024 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
