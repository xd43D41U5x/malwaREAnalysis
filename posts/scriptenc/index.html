<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>ScrEnc - Unknown malware</title>
    <meta name="description" content="Deocoding Windows Script Encoder">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scriptenc/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ScrEnc - Unknown malware">
    <meta property="og:description" content="Deocoding Windows Script Encoder">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ScrEnc - Unknown malware">
    <meta name="twitter:description" content="Deocoding Windows Script Encoder">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scriptenc/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scriptenc/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scriptenc/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>ScrEnc - Unknown malware</h1>
        <small role="doc-subtitle">Deocoding Windows Script Encoder</small>
        <p class="post-date">
            August 22, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>This starts off with a RAR file, which contains a single CHM file (Windows Compiled HTML/help).  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image6.png" alt=""></p>
<p>There are two ways to view the content of this file.  One is to just use 7zip and treat it like an archive.  The other is using the cmd <code>-decompile</code>.  Both will leave you with two main files of note, one is hanacard.html, the other is Docs.jse.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image3.png" alt=""></p>
<p>If you look at the html file, you can see it is running the same decompile command and placing a copy of the javascript file in the path: <code>Users\\Public\\LIbraries\\Docs.jse</code></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image7.png" alt=""></p>
<p>Since the goal of the html file is to essentially run the javascript, we will focus on that.  On initial review the file was in a format I had not seen before and it looked encoded/encrypted in some way.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image14.png" alt=""></p>
<p>As I couldn’t see it being decrypted in the html directly, I decided to do dynamic analysis and saw it will run using wscript without the html.  While trying different things, I tried to launch the js debugger with cscript instead and received an error that helped identify what this was:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image12.png" alt=""></p>
<p>Doing some research on jscript encode, shows this was encoded with the Windows Script Encoder.  Which looks to be deprecated at this time, so it is interesting that a new sample was using this technique.  Multiple articles reference this being broken a while ago and I was able to find a random decoder on github that ended up working (more on this in a few).  The output was something much more readable.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image11.png" alt=""></p>
<p>You can see in this script that function “d” is performing some decoding for us.  Transferring this to Python so I could test a little more gives us this script:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image13.png" alt=""></p>
<p>Then cleaning that up, we get the part at the bottom.  Essentially, persistence is added via a run registry key that references this same js file.  Then a powershell command attempts to pull an executable from the url labimy dot ink/rskme.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image5.png" alt=""></p>
<p>Looking at the alg download via previous attempts to pull it on VT, shows it is a benign, legit, MS file.  The site was down upon review, so no further analysis could be done.  It is assumed that some type of server side check was being performed possibly based on location or the live payload just wasn’t being hosted yet.</p>
<hr>
<h2 id="the-fun-and-more-interesting-part-to-this-since-the-malware-was-a-bust">The fun and more interesting part to this (since the malware was a bust):</h2>
<hr>
<p>However, for fun and so this same method could be used in the future for other tools implementing unknown encoding, I wanted to write a decoder for this in Python.  I started reading this: <a href="https://web.archive.org/web/20131208110057/http://virtualconspiracy.com/content/articles/breaking-screnc">https://web.archive.org/web/20131208110057/http://virtualconspiracy.com/content/articles/breaking-screnc</a></p>
<p>I read just enough of the article to get an idea for the method but I stopped reading the full write-up so I could take some starting points and try this myself.</p>
<p>So by taking large strings of repeating characters, I wanted to look for patterns.  So I feed in hundreds of “A”’s.</p>
<p>By doing this, you can see a repeating pattern every 64 chars:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image8.png" alt=""></p>
<p>Since there is a repeating order, I wrote a quick script to map this out since the first 3 values are unique as “)”, “z”, “b”.  They will be called 0,1,2 in that order.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image4.png" alt=""></p>
<p>The result here is:</p>
<p>0120121221210212021200122102122100212120200120210212001220012021</p>
<p>Just to be sure, this was validated a few more times on other sample character sets.</p>
<p>Now, since the first three values are unique, we really just need those for each possible ascii value.  We will leave in 9 (tab) but then go from 32-126.  I still needed to create a large list of all of these values 64 chars in length so the encoding position would reset and I would be left with the starting 3 chars I knew were unique.</p>
<p>I generated that list with these few lines:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image10.png" alt=""></p>
<p>After running that through the encoder, we can start working on our lookup table.  One note here is because of the way special chars are represented in editors and vscode, the only reliable way to do this is with straight hex values.  I just used a hex editor to grab that data.</p>
<p>Now that we have the output, this script will take those values and create a Python dictionary we can use for the lookups.  We are essentially taking two chars at a time then representing three total values/bytes and adding those to our lookup table.  I also added in some additional items to create the format for a Python dictionary to be used later.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image1.png" alt=""></p>
<p>The output lists each possible position and the matching ascii value, all in decimal values:</p>
<pre tabindex="0"><code>{9:{0:55,1:105,2:100,},32:{0:126,1:44,2:80,},33:{0:90,1:101,2:34,},34:{0:69,1:114,2:74,},35:{0:58,1:91,2:97,},36:{0:121,1:102,2:94,},37:{0:89,1:117,2:93,},38:{0:39,1:76,2:91,},39:{0:118,1:69,2:66,},40:{0:99,1:118,2:96,},41:{0:98,1:42,2:35,},42:{0:77,1:67,2:101,},43:{0:81,1:51,2:95,},44:{0:83,1:66,2:126,},45:{0:82,1:32,2:79,},46:{0:32,1:99,2:82,},47:{0:38,1:74,2:122,},48:{0:84,1:90,2:33,},49:{0:113,1:56,2:70,},50:{0:43,1:121,2:32,},51:{0:102,1:50,2:38,},52:{0:42,1:87,2:99,},53:{0:88,1:108,2:42,},54:{0:127,1:43,2:118,},55:{0:123,1:70,2:71,},56:{0:48,1:82,2:37,},57:{0:49,1:79,2:44,},58:{0:108,1:61,2:41,},59:{0:73,1:112,2:105,},61:{0:120,1:123,2:39,},63:{0:95,1:81,2:103,},65:{0:41,1:122,2:98,},66:{0:36,1:126,2:65,},67:{0:47,1:59,2:90,},68:{0:57,1:71,2:102,},69:{0:51,1:65,2:50,},70:{0:111,1:119,2:115,},71:{0:33,1:86,2:77,},72:{0:117,1:95,2:67,},73:{0:40,1:38,2:113,},74:{0:66,1:120,2:57,},75:{0:70,1:110,2:124,},76:{0:74,1:100,2:83,},77:{0:92,1:116,2:72,},78:{0:72,1:103,2:49,},79:{0:54,1:125,2:114,},80:{0:75,1:104,2:110,},81:{0:125,1:53,2:112,},82:{0:93,1:34,2:73,},83:{0:106,1:85,2:63,},84:{0:80,1:58,2:75,},85:{0:105,1:96,2:106,},86:{0:35,1:106,2:46,},87:{0:9,1:113,2:127,},88:{0:112,1:111,2:40,},89:{0:101,1:73,2:53,},90:{0:116,1:92,2:125,},91:{0:44,1:93,2:36,},92:{0:119,1:39,2:45,},93:{0:68,1:89,2:84,},94:{0:63,1:37,2:55,},95:{0:109,1:124,2:123,},96:{0:124,1:35,2:61,},97:{0:67,1:109,2:108,},98:{0:56,1:40,2:52,},99:{0:94,1:49,2:109,},100:{0:91,1:57,2:78,},101:{0:110,1:127,2:43,},102:{0:87,1:54,2:48,},103:{0:76,1:84,2:111,},104:{0:52,1:52,2:116,},105:{0:114,1:98,2:107,},106:{0:37,1:78,2:76,},107:{0:86,1:48,2:51,},108:{0:115,1:94,2:86,},109:{0:104,1:115,2:58,},110:{0:85,1:9,2:120,},111:{0:71,1:75,2:87,},112:{0:50,1:97,2:119,},113:{0:53,1:36,2:59,},114:{0:46,1:77,2:68,},115:{0:100,1:107,2:47,},116:{0:79,1:68,2:89,},117:{0:59,1:33,2:69,},118:{0:45,1:55,2:92,},119:{0:65,1:83,2:104,},120:{0:97,1:88,2:54,},121:{0:122,1:72,2:88,},122:{0:34,1:46,2:121,},123:{0:96,1:80,2:9,},124:{0:107,1:45,2:117,},125:{0:78,1:41,2:56,},126:{0:61,1:63,2:85,}}
</code></pre><p>We can now take our encoded data, lookup dictionary and position order and write the final script.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image9.png" alt=""></p>
<p>We iterate over the hex data 2 chars at a time along with our current position and look that up in the dictionary.  Since this repeats every 64 chars, we just mod the position during lookup.  The only gotcha here is the escaped “@” values.  I had to reference the other article a little bit and find a roundabout way to handle these in the script but we just look for those values first, handle, flag, then proceed.</p>
<p>The output from that script is what we saw before:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scriptenc/image2.png" alt=""></p>
<p>So,,,</p>
<p>Is this better or a replacement for those other tools on github: no.  </p>
<p>Is it straightforward and easy to understand in Python: sure.</p>
<p>Was this fun to do: absolutely.</p>
<p>Is there a reason I’m asking myself questions and then answering them: nope!</p>
<hr>
<h1 id="files-and-scripts">Files and Scripts</h1>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
<th>Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>hanacard.rar</td>
<td>Initial Rar File</td>
<td>9d5ee125c3f9a948dcc29de1f573487a</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>All seen scripts</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/tree/fc96deae61ce0b91b28f613c921316777bb340e7/WindowsScriptEnc">Link</a></td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2024 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
