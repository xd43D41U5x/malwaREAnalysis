<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>ValleyRAT</title>
    <meta name="description" content="ValleyRAT Technique Review">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/valleyrat/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ValleyRAT">
    <meta property="og:description" content="ValleyRAT Technique Review">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ValleyRAT">
    <meta name="twitter:description" content="ValleyRAT Technique Review">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/valleyrat/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/valleyrat/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/valleyrat/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>ValleyRAT</h1>
        <small role="doc-subtitle">ValleyRAT Technique Review</small>
        <p class="post-date">
            August 26, 2024
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>Digging right in, let&rsquo;s take a look at the api hashing function this sample leverages.  It is fairly easy to spot as you see the same function being called multiple times in a row with a random hex value being pushed right before the call:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image10.png" alt=""></p>
<p>Specifically, the function at 401d49 looks to be doing the hashing.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image40.png" alt=""></p>
<p>To help visualize, we can replicate this in Python:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image4.png" alt=""></p>
<p>By hashing all dlls on the system we can check the calls to this function.  Since there are only 6, this can be done manually.  If there were more calls we could script this within Ghidra.</p>
<p>0x1ab9b854 = GetProcAddress<br>
0x7f201f78 = LoadLibraryA<br>
0x5e893462 = VirtualAlloc<br>
0x6488073 = VirtualFree<br>
0xdb579cb = RtlZeroMemory<br>
0x1518e9c0 = RtlMoveMemory</p>
<p>Now that we know VirtualAlloc is being called, we can set a breakpoint.  Running to that we can see this call:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image13.png" alt=""></p>
<p>Size: A01<br>
Type: Reserve/Commit<br>
Protect: Execute Read/Write</p>
<p>Step into this call, noting the values above and then run to return.  Returning from this call, note EAX, follow that in your dump window and set a hardware write breakpoint at the beginning of that memory section.  Run to that bp and then step over the movsd call to have the region populated.</p>
<p>Mem region:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image17.png" alt=""></p>
<p>You can now technically follow these in memory and save to file, note the read write execute perms:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image39.png" alt=""></p>
<p>At the return of this function it starts to operate on that region of memory (ESI is the start of that region)::</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image29.png" alt=""></p>
<p>Shortly after, there appears to be a decoding loop.  ECX is holding the loop counter and ESI is holding the previously seen size of the written memory region.  This is a simple XOR operation to decode with the key: EE 4F 0E 2D 80 78 FA DE.  So either XOR your previous dump or dump here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image46.png" alt=""></p>
<p>There is also a call to EDI (start address of the memory region) immediately after:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image37.png" alt=""></p>
<p>The decoded code starts the same way as the original in that it is doing api hashing with the same exact method.  0x4807D9 is the hashing function and the push right before is the hashed api it is looking to find:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image20.png" alt=""></p>
<p>VirtualFree<br>
lstrcmpiA<br>
CreateEventA<br>
WaitForSingleObject<br>
CloseHandle<br>
RtlZeroMemory</p>
<p>It now attempts to find a certin section in memory:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image9.png" alt=""></p>
<p>And finds the string “codemark” in this section:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image21.png" alt=""></p>
<p>This section is important as it contains the IP address needed to download the next stage.</p>
<p>That IP is moved in here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image44.png" alt=""></p>
<p>And written to a new memory location allocated with VirtualAlloc, size 0xF</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image1.png" alt=""></p>
<p>There is a call right after to LoadLibraryA for ws2_32.dll, for expected socket access.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image22.png" alt=""></p>
<p>We now see APIs from this library being resolved with the same hashing seen before:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image45.png" alt=""></p>
<p>Resolved in this order:</p>
<p>WSAStartup<br>
socket<br>
getaddrinfo<br>
freeaddrinfo<br>
htons<br>
connect<br>
send<br>
recv<br>
closesocket<br>
WSACleanup</p>
<p>WSAStarup followed by socket:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image12.png" alt=""></p>
<p>Which sets the socket as follows:</p>
<p>Address Family: IPV4 (2)<br>
Type: Stream (1)<br>
Protocol: TCP (6)</p>
<p>VirtualAlloc is called again (another commit with rwx and a large size):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image14.png" alt=""></p>
<p>Getaddrinfo and then connect is now called and we can see the IP address from earlier and port 60 being used:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image28.png" alt=""></p>
<p>Since this is an isolated env, the connect did fail, so we will nop the jmp instruction to see further details about how this operates.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image16.png" alt=""></p>
<p>These are the send values:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image47.png" alt=""></p>
<p>It attempts to send 3 bytes located here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image2.png" alt=""></p>
<p>Just to confirm, I changed the inetsim http listener to port 60 and saw the same bytes:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image19.png" alt=""></p>
<p>VirtualAlloc is called again:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image32.png" alt=""></p>
<p>Right after ws_32 recv is called with the following params:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image8.png" alt=""></p>
<p>The out buffer will be writing to our newly allocated memory region.</p>
<p>RTLmovememory is now called.  The first parm is the dst with the second being our src (received data) and the returned length.  Note: our length is wrong due to the socket error.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image23.png" alt=""></p>
<p>We are now in a recv loop, looking for a certain value (correct length 0x4B00E):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image24.png" alt=""></p>
<p>Next, the memory region of response is called.</p>
<p>I was able to get a pcap from a sandbox so I could fake the response.  Basically on all of the send/recv functions make sure the return length value (EAX) is correct and not an error value.  Then after the recv function update the memory region to include the bytes seen in the pcap.  </p>
<p>The sample uses an xor loop to decode the return contents.  You end up with a shellcode loader and an MZ header.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image7.png" alt=""></p>
<p>Note: The actual shellcode uses the same API hashing function.</p>
<p>Looking at the pcap returned data it is easy to see what single byte XOR value is by checking expected areas of a file (between MZ header and start of the sections as well as the end of the file:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image26.png" alt=""></p>
<p>The XOR decode is 0x36 in this example.</p>
<p>CAPA output:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image97.png" alt=""></p>
<p>This is a dll with several exports:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image27.png" alt=""></p>
<p>However, only dllmain and load will be called.</p>
<p>Setsockopt is called with rcvbuff (0x1002) to define buffer space for recv comms:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image5.png" alt=""></p>
<p>It is called again setting timeout and keepalive</p>
<p>These functions are looking for config files:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image31.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image43.png" alt=""></p>
<p>With the pipe separator:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image36.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image33.png" alt=""></p>
<p>P1: 176.221.16.167<br>
O1: 6.0<br>
T1: 0<br>
P2: 176.221.16.167<br>
O2: 6.0<br>
T2: 0<br>
P3: 0<br>
O3: 0<br>
T3: 0<br>
DD: 0x31<br>
CL: 0x31<br>
FZ: D8 9E A4 8B<br>
BB: 1.0<br>
BZ: 2024. 7. 30<br>
JP: 0<br>
SX: 3<br>
BH: 0<br>
LL: 0<br>
DL: 0<br>
SH: 0<br>
KL: 0<br>
BD: 0</p>
<p>Now we start looking for a registry key “console” in HKCU (1: [esp] 80000001 ):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image41.png" alt=""></p>
<p>With the value at IpDate:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image11.png" alt=""></p>
<p>It does provide a param for “type” but not “data” stored there.  Since this is Null, this only seems to be checking for the existence of this key, presumably as a way to see if it has run before.</p>
<p>Since this did not exist on the test system here, it returns 0x2 (File_Not_Found).</p>
<p>CreateThread is now called at ~60F0</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image18.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image15.png" alt=""></p>
<p>Sleep is called and then CreateMutexW, most likely as a way to see if another instance is already running.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image42.png" alt=""></p>
<p>There is a check right after this call looking for anything but a null value.  That would mean it was able to get a handle to the mutex and another instance could be running.  As a final check, it gets the last error code and checks it against 0xb7, which is a windows error code for “file already exists”.  In that case, it will return/term.</p>
<p>We are now in a recv loop on the socket:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image6.png" alt=""></p>
<p>Going back to the pcap and looking at the next stream, you can see the following (client in red, remote in blue):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image35.png" alt=""></p>
<p>XOR encoding is seen and can be seen with this key:</p>
<p>903a3636363636003677</p>
<p>The client reaches out to the C2 and opens the stream.  The C2 responds with a hash:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image34.png" alt=""></p>
<p>The client responds with a filename:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image25.png" alt=""></p>
<p>The C2 responds with the final payload.  This payload contains the filename, file hash, a shellcode loader and the actual RAT.</p>
<p>The view with CAPA is what you would expect from a typical RAT.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image98.png" alt="">
<img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image99.png" alt=""></p>
<p>The visual of the flow is:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/valleyrat/image3.png" alt=""></p>
<hr>
<h1 id="sample-hashes">Sample Hashes </h1>
<table>
<thead>
<tr>
<th>Description</th>
<th>MD5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initial Sample</td>
<td>12da46158cb3faddf00b0b7ea62ca13e</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="tools">Tools</h1>
<table>
<thead>
<tr>
<th>Tool</th>
<th>Description</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>apihash.py</td>
<td>General script to generate a local api hash list</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/master/apiHash.py">LINK</a></td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2024 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
