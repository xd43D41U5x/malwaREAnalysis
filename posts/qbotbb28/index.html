<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Qbotbb28</title>
    <meta name="description" content="Review of new JS obfuscation related to Qakbot version BB28">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/qbotbb28/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Qbotbb28">
    <meta property="og:description" content="Review of new JS obfuscation related to Qakbot version BB28">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Qbotbb28">
    <meta name="twitter:description" content="Review of new JS obfuscation related to Qakbot version BB28">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/qbotbb28/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/qbotbb28/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/qbotbb28/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Qbotbb28</h1>
        <small role="doc-subtitle">Review of new JS obfuscation related to Qakbot version BB28</small>
        <p class="post-date">
            May 20, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>The JS starts with a fake Angular comment followed by multiple references to Angular in variable names.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image15.png" alt=""></p>
<p>The first item to note is the dead code that was injected during this obfuscation.  To start cleaning this up, look at the patterns of variable declarations and junk functions that are never actually referenced such as:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image7.png" alt=""></p>
<p>Once you start cutting those items out it&rsquo;s easy to see this is a variation of obfuscator io.</p>
<p>Here is the while loop that performs the string array shifts:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image1.png" alt=""></p>
<p>This pattern is recognizable because of the while True loop, with parseInts and the corresponding push/shifts seen in the Try portion.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image5.png" alt=""></p>
<p>The thing that makes this form of obfuscator io different is the way its masking key values by throwing dozens of parameters to the function, then only using a few in the actual return.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image2.png" alt=""></p>
<p>The other item that makes this different is that instead of one main string shift function or even a main with an intermediate function to handle the offset, three separate functions spread out randomly.  </p>
<p>I was able to clean this up and step through it but the easiest way to do this would be to update FR4K to handle, or like I did here, just make a quick one off script that is based on FR4K.  With all of the variations you can see in obfuscator io, FR4K makes a good template to grab the needed portions and create something new for the use case.</p>
<p>The first step was to add a join and then a debugger statement to the while loop.</p>
<p>In this case, we will place it right before the while break so the string list is in the correct order.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image3.png" alt=""></p>
<p>Now once this stops just copy out the correctly ordered string list from the browser debugger and we can leverage that in a Python script.</p>
<p>The next item is find the encoded strings we want to focus on:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image10.png" alt=""></p>
<p>Then see what other items it&rsquo;s doing to those as obfuscator io has many options it can use here.</p>
<p>So I see this common portion where its doing a one off b64 decode:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image6.png" alt=""></p>
<p>However, I don’t see any rc4 decryption that I normally expect with that.</p>
<p>The other item I see is that the three functions doing this string replacement send two values to this decode function, but only the first one is used:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image17.png" alt=""></p>
<p>So in this example, the only one that really matters is the first value it sends.  It takes this value and subtracts 0x338 and that is the only number that matters.</p>
<p>Once in the decode function, it subtracts 261 from this number and then looks that value up in the string list.</p>
<p>Converting this over to Python to deob:</p>
<p>Note: the reason I’m doing this in python is that I want the full deob values and don’t want the JS to try to actually eval anything.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image13.png" alt=""></p>
<p>We basically convert the string “function” to “def” so we can make a Python function, then just clean up some of the semicolons and brackets so they work correctly here.</p>
<p>As for the decode function, it always seems to be exactly the same for these obfuscator io items and can be seen in FR4K.</p>
<p>Now it&rsquo;s just as easy and copying over the needed three functions and the variables you are interested in and getting the output:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image14.png" alt=""></p>
<p>After going through a few of these you can see the strings are reversed (below shows the string “open”):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image4.png" alt=""></p>
<p>What’s more is that when cleaning this code up, the bulk is just a series of split/reverse/join statements to swap these back around.</p>
<p>Cleaning up that original JS of over 1k lines of code produces something much more readable that essentially is just a few lines of code containing an if/else statement.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image8.png" alt=""></p>
<p>It looks like this if/else is looking for args, but really the main goal would be to execute the chunk of base64.  When the powershell is called to run that, it is prepended with “JAB1AHIAZQ”.  Obviously without that it would not decode correctly.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image11.png" alt=""></p>
<p>This final portion just has very mild obfuscation in the way of base64 and unused/junk code inserted.  There is unused variables as well as decoded partial urls:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image9.png" alt=""></p>
<p>After a full cleanup, the resulting code looks like this:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image16.png" alt=""></p>
<p>It will attempt three different urls and if any of those connect successfully, it will save a file of at least 109595 bytes.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/qakbotbb28/image12.png" alt=""></p>
<p>We won’t continue with Qakbot reversal as the only newer item of note was the form of JS obfuscation being used.</p>
<h1 id="iocs">IOCs</h1>
<table>
<thead>
<tr>
<th>Type</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>URL/IP</td>
<td>hxxp://158[.]255[.]213[.]181/miR/pbSzUpuZxJ</td>
</tr>
<tr>
<td>URL/IP</td>
<td>hxxp://162[.]252[.]172[.]54/9GQ5A8/5y6LFrxH</td>
</tr>
<tr>
<td>URL/IP</td>
<td>hxxp://149[.]154[.]158[.]91/Xnd/83rRnGI95q</td>
</tr>
<tr>
<td>Dropped File</td>
<td>C:\ProgramData\TiderodeReinhabitation.rilingShrews</td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2024 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
