<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>NightHawk</title>
    <meta name="description" content="Review of NightHawk">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/nighthawk/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="NightHawk">
    <meta property="og:description" content="Review of NightHawk">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="NightHawk">
    <meta name="twitter:description" content="Review of NightHawk">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/nighthawk/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/nighthawk/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/nighthawk/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>NightHawk</h1>
        <small role="doc-subtitle">Review of NightHawk</small>
        <p class="post-date">
            April 17, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>This starts like a normal ISO file style malware, LNK file (ending in .pdf) and hidden dll (here named thumbs.db).</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image16.png" alt=""></p>
<p>Compliance-checklist.pdf = 9C54FCA1F05AC5442EEBBDC7C02ADA2389DAD61160D8DAEECD568B318964B19A</p>
<p>Thumbs.db = SHA256 = 252A8525216A2D068B7C92C14CD7292FB776193EDDB18E2AE5C11DBF9E1CFE46</p>
<p>The LNK file has a visible link of:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image19.png" alt=""></p>
<p>However, there is much more:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image28.png" alt=""></p>
<p>Somewhat clean version:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image34.png" alt=""></p>
<p>Basically, it is looking for MS Teams in the users local app data directory, then renaming ffmpeg.dll to orgcr32.dll.  Ffmpeg is a legit dependency for Teams, however the orgcr32 is not.  The legit ffmpeg dll is replaced with the thumbs.db file (keeping the correct dll name) and then is executed at the entry point when it&rsquo;s loaded by Teams.</p>
<p>Quick note on this dll.  It seems like just my version of Teams but getting it to reliably execute the dll seemed hit and miss.  To avoid this, I made a very simple program to load the dll for me.  This helps avoid issues around local and heap alloc memory issues that sometime come up when loading directly.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image21.png" alt=""></p>
<p>In the Dll the malicious function in the entry is here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image12.png" alt=""></p>
<p>And contains this function, which does a few things:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image8.png" alt=""></p>
<p>As seen in the above screenshot, a mutex is created with the name “mtxnm” and then a new thread is created to call the function FUN_6eec17f0.</p>
<p>This function immediately calls another:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image4.png" alt=""></p>
<p>This new function takes no parameters and has a few items at the beginning that gives the program a few “outs” to not actually run.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image18.png" alt=""></p>
<p>The first early out is a call to _time, which grabs the current epoch time.  It will exit right away if it&rsquo;s less than 0x6466BC01, which converts to 1684454401 in decimal.  This is Friday, May 19, 2023 12:00:01 AM GMT.  So at a future date, this will no longer run.</p>
<p>The next function call, FUN_6eec10b0, only deals in hashes of local system information (second early out).  </p>
<p>System name:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image11.png" alt=""></p>
<p>Domain Name:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image23.png" alt=""></p>
<p>User name:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image29.png" alt=""></p>
<p>Hashing each along the way with SHA256 after a conversion to lowercase.  The value 0x800c seen in CryptCreateHash is for CALG_SHA_256A256:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image41.png" alt=""></p>
<p>After computing the SHA256 hashes on the local system, it compares those to hard coded values in the .data section here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image7.png" alt=""></p>
<p>The Loop grabs 0x20 at a time and works down through this list based on the loop counter of 0xE.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image25.png" alt=""></p>
<p>Returning from that function there is a test here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image5.png" alt=""></p>
<p>Which skips the next stage and just returns.  It seems like the hash values should match a known set to continue, otherwise return and don’t launch the second stage dll.</p>
<p>As for the hashes, pushing them against public available rainbow tables, surprisingly some did return a result.  Here are the hashes and results:</p>
<!-- raw HTML omitted -->
<p>2-BC5FB9ABE8D5E72EB49CF00B3DBD173CBF914835281FADD674D5A2B680E47D50=aberdeen</p>
<p>3-DDD83756DF14AAFBFADE3D2F4994498F97EB42E7879951F595EE11B5531EDABB=aberdeen-asset[.]com</p>
<p>4-05BF7FEB23EBED7822D9FF78B12427BAD41542FF6DE65B249B04E295B8810EC3=not_found</p>
<p>5-371E756E077226648D88038453EDE7CD18F1AFAFCCFB6657D2A1E169C584646A=abrdn</p>
<p>6-70B5B31B2FB71BB3F61479AB00878930C2551DDD5EE1D8571EC39F5280421DB4=not_found</p>
<p>7-73762AA32C86952BECDCF6F639EA0D6128F3E71BB07CDD316B9A0991F1A7D9B3=not_found</p>
<p>8-369FCA4C75F0F079D2D583C9A4ED3056FCB271826976F50F132F4BE1576F46E8=not_found</p>
<p>9-DDD83756DF14AAFBFADE3D2F4994498F97EB42E7879951F595EE11B5531EDABB=aberdeen-asset[.]com(dup)</p>
<p>10-05BF7FEB23EBED7822D9FF78B12427BAD41542FF6DE65B249B04E295B8810EC3=not_found(dup)</p>
<p>11-9D6386F4BB7D99EFB0287ACC23367E90D40D39A6254D0438197C3D5EC934DA9A=not_found</p>
<p>12-9F36975157774A8274E38602D436A2694F8FE988887A712CFBA744EE8931AB69=not_found</p>
<p>13-B8B33C47C5B9EAE556D629A577D87E3EFC4A0CA37907E3B8C2FEB9417B87F341=not_found</p>
<p>14-E380F80F3C1F9079F8B706FCC0509179BC46554C7C358361F9D8C43DB23AF1E9=not_found</p>
<!-- raw HTML omitted -->
<p>In this case, that matches to a company called Aberdeen Asset Managers, which is an investment mgmt firm.  The assumption here is this was an extremely targeted attack or this was a valid RT exercise that made it into the public.  The latter seems more likely.</p>
<p>To make analysis easier from this point, I patched the jmp seen above from 0x0F 0x84, to end with 0x85, which will invert the jump and continue even though we don’t match one of those hashes.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image1.png" alt=""></p>
<p>The next stage dll is now decoded.  A byte is moved in from a location in .data: ie here F9<br>
<img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image17.png" alt=""></p>
<p>XOR’d with values here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image33.png" alt=""></p>
<p>Then moves that result and loops 0x13621b:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image10.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image39.png" alt=""></p>
<p>We end up with a decoded dll with a few interesting notes.  The first is, the dll is prepended with shellcode, the second is the PE file header has been stomped (sections, IAT, etc):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image31.png" alt=""></p>
<p>When createthread is called, a jmp instruction is passed as the start address and the decoded dll is passed as a parameter:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image37.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image22.png" alt=""></p>
<p>Basically, RCX contains the dll that was passed as the parameter.</p>
<p>RAX will contain the starting portion of the dll, right before the MZ header.  It adds 0xBBBA9 and then jumps there, which is presumably the entry point.</p>
<p>Note: This is the shellcode prepended to the dll.  Its only purpose is to find the entrypoint and jump there.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image6.png" alt=""></p>
<p>The entry point starts with the highlighted line here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image30.png" alt=""></p>
<p>Since the PE header was stomped, analysis from here is much more difficult.  The sections are still there but ghidra can’t find the references.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image24.png" alt=""></p>
<p>To further complicate things, it loads stacked strings to aid in unhooking user mode then performs direct syscalls:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image26.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image40.png" alt=""></p>
<p>Another reason it can be hard to follow statically is that it moves a dll location onto the stack and then call that later on.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image3.png" alt=""></p>
<p>This malware sample uses a simple substitution cipher for important strings.  Looking at the dll, you can see chunks of these with padding that makes them stand out (see AYt… in memory below)</p>
<p>Using string sub cipher, you can see the build for the string in question, then the load of the cipher/clear alphabets:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image9.png" alt=""></p>
<p>This is the loop that performs the sub cipher:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image2.png" alt=""></p>
<p>The cipher text here is highlighted and multiple chunks of this cipher text can be seen because of the added padding:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image20.png" alt=""></p>
<p>With the result being written here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image36.png" alt=""></p>
<p>Using a simple cipher sub we can decode in python:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image43.png" alt=""></p>
<p>With the same result:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image14.png" alt=""></p>
<p>This is a known technique that NightHawk uses for string obfuscation.  Because the cipher and the decoded alphabet will be easy to identify, a simple strings search and review will be able to spot these.  Also, the obfuscated strings will be in the same area and also easy to spot due to the chunks with trailing null padding.</p>
<p>The next item we are interested in is the implant config.  On initial run thru I saw it being referenced but want to see exactly where it&rsquo;s being called and how it is converted to the clear.  The previous call here pulls in the string section with the config already decoded.  Looking closely at this, you can see some obfuscated data and some cleartext strings of true/false.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image15.png" alt=""></p>
<p>With the memory region shown here:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image38.png" alt=""></p>
<p>This will then use the same sub cipher as before.</p>
<p>Decoding this config is quite lengthy and looks to be doubled, however the full block that was referenced above decoded is:</p>
<pre tabindex="0"><code>{&#34;implant-config&#34;:{

  &#34;listener-name&#34;: &#34;chester2s2&#34;,

  &#34;copyright-notice&#34;: &#34;This software is copyright of MDSec Consulting Ltd (c) 2022, our EULA prohibits reverse engineering. By accessing this content you implicitly agree to the EULA available at hxxps://www.mdsec.co\[.\]uk/eula.pdf and agree liability for license fees&#34;,

  &#34;mode&#34;: &#34;egress&#34;,

  &#34;egress-config&#34;: {

    &#34;resolve-proxies&#34;: true,

    &#34;c2-uri&#34;: &#34;hxxps://abrdn-assets-analytics.uksouth.cloudapp.azu\[.\]com&#34;,

    &#34;proxy-resolve-uri&#34;: &#34;hxxps://go.microsoft\[.\]com&#34;,

    &#34;retry-attempts-on-error&#34;: 99999,

    &#34;aes-128-key&#34;: &#34;772336ef698db607&#34;,

    &#34;--proxy-override-credentials&#34;: &#34;peter:winter&#34;,

    &#34;aes-128-iv&#34;: &#34;d78107916d0f415f&#34;,

    &#34;--proxy-override-uri&#34;: &#34;127.0.0.1:8081&#34;,

    &#34;commands&#34;: {

      &#34;putresult&#34;: {

        &#34;response-success&#34;: {

          &#34;status&#34;: 200

        },

        &#34;build-request&#34;: {

          &#34;body&#34;: &#34;session=&lt;payload:BuiltIn.Text.Base64UrlEncode&gt;&#34;,

          &#34;method&#34;: &#34;post&#34;,

          &#34;headers&#34;: {

            &#34;User-Agent&#34;: &#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36 Edg/109.0.1418.71&#34;,

            &#34;Connection&#34;: &#34;close&#34;,

            &#34;Cookie&#34;: &#34;\_ga=&lt;metadata:BuiltIn.Text.Base64UrlEncode&gt;&#34;,

            &#34;Accept&#34;: &#34;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,\*/\*;q=0.8,application/signed-exchange;v=b3;q=0.9&#34;

          },

          &#34;path&#34;: &#34;/\_api/v4.3/background/jruDfT-/ref=&lt;metadata:BuiltIn.Text.Base64UrlEncode&gt;&#34;

        }

      },

      &#34;status&#34;: {

        &#34;response-success&#34;: {

          &#34;status&#34;: 200

        },

        &#34;build-request&#34;: {

          &#34;path&#34;: &#34;/\_api/v4.3/background/jruDfT-/ref=&lt;metadata:BuiltIn.Text.Base64UrlEncode&gt;&#34;,

          &#34;method&#34;: &#34;get&#34;,

          &#34;headers&#34;: {

            &#34;User-Agent&#34;: &#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36 Edg/109.0.1418.71&#34;,

            &#34;Connection&#34;: &#34;close&#34;,

            &#34;Accept&#34;: &#34;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,\*/\*;q=0.8,application/signed-exchange;v=b3;q=0.9&#34;,

            &#34;DNT&#34;: &#34;1&#34;

          }

        }

      },

      &#34;getcommand&#34;: {

        &#34;response-success&#34;: {

          &#34;body&#34;: &#34;^(?P&lt;payload:BuiltIn.Text.Base64UrlDecode&gt;.+)$&#34;,

          &#34;status&#34;: 200

        },

        &#34;build-request&#34;: {

          &#34;path&#34;: &#34;/\_api/v4.3/background/jruDfT-/ref=&lt;metadata:BuiltIn.Text.Base64UrlEncode&gt;&#34;,

          &#34;method&#34;: &#34;get&#34;,

          &#34;headers&#34;: {

            &#34;User-Agent&#34;: &#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36 Edg/109.0.1418.71&#34;,

            &#34;Connection&#34;: &#34;close&#34;,

            &#34;Accept&#34;: &#34;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,\*/\*;q=0.8,application/signed-exchange;v=b3;q=0.9&#34;,

            &#34;X-Requested-With&#34;: &#34;XMLhxxpRequest&#34;

          }

        }

      },

      &#34;listcommands&#34;: {

        &#34;response-success&#34;: {

          &#34;status&#34;: 200,

          &#34;headers&#34;: {

            &#34;Set-Cookie&#34;: &#34;^.\*?\_\_X-CSRF-TOKEN=(?P&lt;payload:BuiltIn.Text.Base64UrlDecode&gt;\[^;\]+).\*$&#34;

          }

        },

        &#34;build-request&#34;: {

          &#34;path&#34;: &#34;/\_api/v4.3/background/jruDfT-/ref=&lt;metadata:BuiltIn.Text.Base64UrlEncode&gt;&#34;,

          &#34;method&#34;: &#34;get&#34;,

          &#34;headers&#34;: {

            &#34;User-Agent&#34;: &#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36 Edg/109.0.1418.71&#34;,

            &#34;Connection&#34;: &#34;close&#34;,

            &#34;Accept&#34;: &#34;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,\*/\*;q=0.8,application/signed-exchange;v=b3;q=0.9&#34;,

            &#34;DNT&#34;: &#34;1&#34;

          }

        }

      }

    },

    &#34;fallback-p2p&#34;: false,

    &#34;c2-fallback-uri&#34;: &#34;&#34;

  },

  &#34;general-config&#34;: {

    &#34;settings&#34;: {

      &#34;jitter&#34;: 22,

      &#34;expire-after&#34;: 1685448052,

      &#34;interval&#34;: 60

    },

    &#34;injector&#34;: {

      &#34;spawn-to&#34;: &#34;c:\\\\windows\\\\system32\\\\WerFault.exe&#34;,

      &#34;parent-process&#34;: &#34;explorer.exe&#34;,

      &#34;use-rwx&#34;: true,

      &#34;methods&#34;: {

        &#34;ProcessCreate&#34;: &#34;CreateProcessWinApi&#34;,

        &#34;ThreadOpen&#34;: &#34;CreateNewThreadNative&#34;,

        &#34;AllocMemory&#34;: &#34;VirtualAllocNative&#34;,

        &#34;ExecuteMemory&#34;: &#34;QueueAPCNativeIndirect&#34;,

        &#34;WriteMemory&#34;: &#34;WriteProcMemNative&#34;,

        &#34;ProcessOpen&#34;: &#34;OpenProcessNative&#34;,

        &#34;ProtectMemory&#34;: &#34;VirtualProtectNative&#34;

      }

    },

    &#34;opsec&#34;: {

      &#34;--block-dlls&#34;: \[

        &#34;amsi.dll&#34;

      \],

      &#34;unhook-via-native&#34;: true,

      &#34;loader-unhook&#34;: true,

      &#34;indirect-syscalls&#34;: true,

      &#34;update-opsec-on-config-change&#34;: true,

      &#34;--self-encrypt-mode-x86&#34;: &#34;no-stub-rop&#34;,

      &#34;loader-unhook-clear-guard&#34;: true,

      &#34;indirect-syscalls-from-dlls&#34;: \[\],

      &#34;loader-indirect-syscalls&#34;: true,

      &#34;self-encrypt-evade-detections&#34;: true,

      &#34;loader-getproc&#34;: &#34;native&#34;,

      &#34;clear-veh-on-imp-res&#34;: false,

      &#34;loader-loadlib&#34;: &#34;darkload&#34;,

      &#34;self-encrypt-after&#34;: 5,

      &#34;--darkload-dll-inclusions&#34;: \[\],

      &#34;--self-encrypt-mode-x64&#34;: &#34;no-stub-rop&#34;,

      &#34;patch-etw-event&#34;: true,

      &#34;--darkload-dll-exclusions&#34;: \[\],

      &#34;clear-dll-notifications&#34;: true,

      &#34;ordinary-export&#34;: &#34;CPlApplet&#34;,

      &#34;loader-strategy&#34;: &#34;syscalls&#34;,

      &#34;self-encrypt-mode&#34;: &#34;no-stub-timer&#34;,

      &#34;self-encrypt-while-listening&#34;: true,

      &#34;reapply-opsec-on-self-encrypt&#34;: true,

      &#34;use-threadpool&#34;: true,

      &#34;loader-erase-keystub&#34;: true,

      &#34;hide-windows&#34;: false,

      &#34;--inproc-stomp-assembly-name&#34;: &#34;System.Web.Mobile, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7c11e50a3a, processorArchitecture=MSIL&#34;,

      &#34;darkload-dll-only-implant-threads&#34;: false,

      &#34;darkload-dll-remove-from-peb&#34;: true,

      &#34;loader-avoid-heapalloc&#34;: false,

      &#34;unhook-clear-guard&#34;: true,

      &#34;clear-hwbp-on-imp-res&#34;: true,

      &#34;clear-hwbp-on-unhook&#34;: true,

      &#34;darkload-dll-remove-from-hashlinks&#34;: true,

      &#34;unhook-syscalls&#34;: true,

      &#34;clear-veh-on-unhook&#34;: false,

      &#34;darkload-dll-encrypt-at-sleep&#34;: false,

      &#34;sleep-mode&#34;: &#34;wait-single&#34;,

      &#34;masquerade-thread-stacks&#34;: true,

      &#34;--use-hwbp-for&#34;: \[

        &#34;patch-etw-event&#34;,

        &#34;patch-amsi&#34;

      \],

      &#34;encrypt-heap-mode&#34;: &#34;implant&#34;,

      &#34;loader-export&#34;: &#34;ReflectiveLoader&#34;,

      &#34;loader-disable-pi-callback&#34;: true,

      &#34;loadlibrary-mode&#34;: &#34;darkload&#34;,

      &#34;unhook-using-wpm&#34;: true,

      &#34;thread-start-addresses&#34;: \[

        &#34;ntdll!RtlUserThreadStart&#34;

      \],

      &#34;disable-pi-callback&#34;: true,

      &#34;patch-amsi&#34;: true,

      &#34;inproc-prevent-exit-default&#34;: true,

      &#34;--backing-module&#34;: {

        &#34;x86&#34;: &#34;chakra.dll&#34;,

        &#34;replace-peb-dll-entry&#34;: \[\],

        &#34;x64&#34;: &#34;chakra.dll&#34;

      },

      &#34;stomp-pe-header&#34;: true,

      &#34;unhook-dlls&#34;: \[

        &#34;kernel32.dll&#34;,

        &#34;ntdll.dll&#34;,

        &#34;kernelbase.dll&#34;,

        &#34;winhxxp.dll&#34;

      \],

      &#34;loader-thread-behaviour&#34;: &#34;legacy&#34;,

      &#34;syscalls-spoof-ret-dlls&#34;: \[

        &#34;advapi32&#34;,

        &#34;user32&#34;,

        &#34;kernel32&#34;,

        &#34;kernelbase&#34;,

        &#34;ntdll&#34;

      \],

      &#34;use-syscalls&#34;: true

    },

    &#34;code-modules&#34;: {

      &#34;encoders&#34;: \[\],

      &#34;p2p-transports&#34;: \[\],

      &#34;egress-transports&#34;: \[\]

    }

  },

  &#34;p2p-config&#34;: {

    &#34;promote&#34;: false,

    &#34;promote-after&#34;: \[\],

    &#34;p2p-listener-uri&#34;: &#34;smb\[:\]//crashpad\_3237\_22363558115&#34;,

    &#34;aes-128-iv&#34;: &#34;d78107916d0f415f&#34;,

    &#34;aes-128-key&#34;: &#34;772336ef698db607&#34;,

}
</code></pre><p>This encrypted block can be seen in the dumped dll here (near the end):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image27.png" alt=""></p>
<p>The AES key is on the front of the block, with a little space and then starting at E8 0C.  This key can be seen being referenced leading up to the decrypt functions.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image42.png" alt=""></p>
<p>This loop moves the encrypted code block in:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image13.png" alt=""></p>
<p>With memory containing the encrypted block we saw before:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image35.png" alt=""></p>
<p>Then, can be seen in RAX after being returned from decryption.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/nighthawk/image32.png" alt=""></p>
<p>The encrypted block is AES decrypted with the key=TcoVrVgrLklOHkYc, IV=0000000000000000000000000000000, then un-gzip the result.</p>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
