<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>ScrubCrypt/XWorm</title>
    <meta name="description" content="Review of ScrubCrypt/XWorm">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scrubcrypt/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ScrubCrypt/XWorm">
    <meta property="og:description" content="Review of ScrubCrypt/XWorm">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ScrubCrypt/XWorm">
    <meta name="twitter:description" content="Review of ScrubCrypt/XWorm">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scrubcrypt/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scrubcrypt/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/scrubcrypt/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>ScrubCrypt/XWorm</h1>
        <small role="doc-subtitle">Review of ScrubCrypt/XWorm</small>
        <p class="post-date">
            March 12, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="analysis">Analysis</h1>
<p>For this sample, the batch file decrypts two payloads, one is another unpacker/dropper and the other is a .Net executable with a singular purpose of bypassing ETW so that EDR and AV will not stop the final payload.  The .Net unpacker/dropper contains resources that it decodes then loads into memory.   One of which looks to be XWorm (based on C2 strings) and the other is an unidentified native/compiled executable that will be covered in a separate report.</p>
<p>Note: See the appendix for details around how this is purchased as a package and features it offers as ScrubCrypt.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image7.png" alt=""></p>
<p>The batch file is storing a series of base64 values in a comment section at the top of this file.  There are multiple values here separated by a backslash, which will be discussed later.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image2.png" alt=""></p>
<p>The batch file is using string replacement as a method of obfuscation.  In the screenshot below, it&rsquo;s setting a value padded with additional short strings of random characters.  In the command right below the “set”, its performing the string replacement when calling powershell, specifically, %P:CspfWm=</p>
<p>The syntax here is, %variable:valueToReplace=newValue.  So in this case, it&rsquo;s looking for the noted string and then replacing it with nothing.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image1.png" alt=""></p>
<p>To clean this quickly (vs manual deob), a short python program can find the replacement pattern noted above and clean the code.  One example is:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image4.png" alt=""></p>
<p>Snippet of the cleaned code:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image3.png" alt=""></p>
<p>The code attempts to find powershell (32 vs 64) in system directories and then makes a copy of that to the current working directory.  Somewhat cleaned function names result in a few items of note in the screenshot below.  </p>
<ol>
<li>It reads itself in</li>
<li>Takes the base 64 in the top comment and splits that on the backslash creating an array of four (0-3) base64 values.</li>
<li>Value 0 and 1 are the encrypted payloads with value 2 and 3 being the KEY and IV.</li>
<li>The payload along with the KEY and IV are passed to a standard powershell AES decrypt function, then to be uncompressed (gzip).</li>
<li>Finally both payloads are executed in memory with a standard reflection load command with no entry point given.</li>
</ol>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image6.png" alt=""></p>
<p>The first file executed is a .NET executable available on VT with no common malicious name given.</p>
<p>With the following hash values:</p>
<p>md5: 90BFDBAA1A1209DEED8C941BAC71F51A</p>
<p>sha1: 4FA32272EF482E80300AA0C806BC435781A34122</p>
<p>sha256: BA34A54982E6C800F09B0A72F40CC0AF074DCA0678BE1A4A66996679C2D6E663</p>
<p>With an original filename noted as: kUAptF.tmp</p>
<p>With .NET module noted as: ScrubCrypt</p>
<p>With two encrypted (assumed on initial review by non-readable characters, no file header and high entropy) resource files:</p>
<ol>
<li>name: ‘P’, hash: b190d3358ce6f273b03c9517efe4cd52</li>
<li>name: ‘UAC’, hash: ea79fe56e04b46b806d44f7cccf83ca9</li>
</ol>
<p>The second executed file is also a .NET executable not found on VT.</p>
<p>With the following hash values:</p>
<p>md5: D6C1E450B2A140DD67836802DACCAA37</p>
<p>sha1: 9E0CD9B14FC1EB81CE8219514E82D6DDBA6B6474</p>
<p>sha256: 182EB7711D20603AC6F3FBF7A7B76041567906F1A2025920064A89875B0C5B5F</p>
<p>With original filename noted as: BfSVRn.tmp</p>
<p>With .NET module noted as: BsSVRn</p>
<p>There were no resources of note on this second file.</p>
<p>Initial analysis of both .NET executables show a form of unicode obfuscation is occurring.  </p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image5.png" alt=""></p>
<p>After running through de4dot, the cleaned files are much more readable.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image9.png" alt=""></p>
<p>While it’s much more readable and you can tell generally what it&rsquo;s doing, key IOCs are still unicode encoded and being passed to a decode function named <!-- raw HTML omitted -->.smethod_0, which takes the encoded string along with the second numerical value passed.  This function then converts the unicode character to its integer representation, subtracts the noted numerical value and converts back to a character value, appending each round to return a whole string.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image8.png" alt=""></p>
<p>Since attempting to debug the program in dnSpy and pushing it to take every available avenue would be time consuming, writing an almost identical program in C#, then taking the key values as inputs helps clean this up faster.  It is almost identical except for some input parsing.  The key here is that the new terminal on Windows 11 can handle the unicode values being pasted, however the standard cmd window available on Windows 10 cannot.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image12.png" alt=""></p>
<p>One example of the decoder working:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image10.png" alt=""></p>
<p>After cleaning both analysis is as follows.</p>
<p>The first program:</p>
<ol>
<li>
<p>Gets the current process and deletes the original executed file.</p>
</li>
<li>
<p>Checks for debugger</p>
</li>
<li>
<p>Checks for admin priv by querying System.Security.Principal WindowsBuildInRole and comparing that to 544 (admin).</p>
</li>
<li>
<p>Create mutex named aLQofaliAX without initial ownership</p>
</li>
<li>
<p>Checks OS version number</p>
</li>
<li>
<p>If you are not an administrator the following steps are taken:</p>
</li>
<li>
<p>Creates the directory: \\?\C:\Windows \System32 (note the additional space)</p>
</li>
<li>
<p>It should be noted this is the first part in a known technique in bypassing UAC, in that trusted programs run from system32 do not display the uac prompt.  In this case, the mock directory is treated the same on windows and creates the first step in the bypass.</p>
</li>
<li>
<p>Copies a legit version of perfmon.exe to this new directory.</p>
</li>
<li>
<p>Writes resource name UAC to this new directory as SSPICLI.dll.</p>
</li>
<li>
<p>The resource is copied to a memory stream and uncompressed(gzip)</p>
</li>
<li>
<p>This is an unknown compiled executable with no entry on VT: 56AB99B11AE1ADADEE809547637019CD.</p>
</li>
<li>
<p>It should be noted the export of GetUserNameExW, however given the name of UAC and then comparing that vs advertised services for this malware, this is most likely UAC bypass as it sounds.  See notes for this program below for additional details.</p>
</li>
<li>
<p>Launches the new copy of perfmon with local shell with powershell.</p>
</li>
<li>
<p>The reason for this is that we just created a payload in this directory with the name SSPICLI.dll, which perfmon will load upon execution.  It is essentially leveraging dll search order hijacking to get the legit process to load the malicious code.</p>
</li>
<li>
<p>Launches powershell, uses add-mppreference along with the root dir to add a defender exclusion.</p>
</li>
<li>
<p>Loads the resource &ldquo;P&rdquo; into memory directly.</p>
</li>
<li>
<p>The resource is copied to the memory stream first and then goes through a decode function.</p>
</li>
<li>
<p>The resource is XOR decoded with the key: qUEWsZuItJYdCmbziUIPxqjNHnYiATMN.</p>
</li>
<li>
<p>After decoding, it is then uncompressed (gzip).</p>
</li>
<li>
<p>The file has the hash: 7F52985A00B00A858AF45A63274AF385, and is on VT with notes to coinminer or agent tesla.  </p>
</li>
<li>
<p>Creates a copy of the original bat file in the users appdata roaming directory.</p>
</li>
<li>
<p>Creates a file in the users appdata roaming directory called \ZrJMw.vbs which contains a generic WScript.Shell Run command which launches the bat file in the same directory.</p>
</li>
<li>
<p>Uses powershell to create a new scheduled task, which runs at logon named: RuntimeBroker_ZrJMw, which contains the task action &ldquo;-execute to run the vbs script located in the users appdata roaming directory.</p>
</li>
<li>
<p>In the event this fails, it will attempt to create a run registry key named RuntimeBroker_ZrJMw and the value wscript.exe, calling the same WScript shell run command to launch the same vbs.</p>
</li>
</ol>
<p>Reviewing both executed resources from this first program.</p>
<p>High Level Overview of resource named “P”:</p>
<p>32 bit .NET Executable with md5 of 7F52985A00B00A858AF45A63274AF385 and original name of NewBin30.exe</p>
<p>Function under Stub namespace within main class:</p>
<p>Encrypted Config:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image11.png" alt=""></p>
<p>Worm name and C2 url of note:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image13.png" alt=""></p>
<p>Additional notes:</p>
<p>Function SendBot:</p>
<ol>
<li>
<p>String being built notes “XWorm V3.0”.</p>
</li>
<li>
<p>WebClient connects to api[.]telegram[.]org/bot</p>
</li>
<li>
<p>path: /sendMessage?chat_id=</p>
</li>
<li>
<p>param: &amp;text=</p>
</li>
<li>
<p>Text in this case being, the worm name, client id, username and os name.</p>
</li>
</ol>
<p>Config is AES Decrypted:</p>
<ul>
<li>
<p>The key is a byte array of the “mutex” setting, taking the first 16 digits of the md5 of that value and doubling.</p>
</li>
<li>
<p>Host: bromleytaxes[.]duckdns[.]org</p>
</li>
<li>
<p>Port: 9001</p>
</li>
<li>
<p>Key: 123456789</p>
</li>
<li>
<p>SPL: Xwormmm</p>
</li>
<li>
<p>USBNM: USB.exe</p>
</li>
<li>
<p>Token: 6161259061:AAEQd-uTv3e6Rcq3LJzGr81a8D_PEJnkRhs</p>
</li>
<li>
<p>ChatID: 5732969611</p>
</li>
</ul>
<p>UAC Analysis:</p>
<p>Found references advertising this malware as ScrubCrypt with features for UAC bypass. Exact technique to come if time permits for analysis.</p>
<p>The second program launched from the initial batch file:</p>
<p>This program uses the same type of obfuscation technique with multiple areas of unicode values but also the same decode function that was noted above that converts the unicode to integers, shifts the value and then converts it back to readable characters.  After initial cleaning with de4dot, we can see similar functions:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image14.png" alt=""></p>
<p>The program decodes its string values and then by using a combination of GetModuleInform, CreateFile, FileMapping, MapViewofFile, then VirtualProtect, memcpy followed by one final VirtualProtect, it looks through all available dll modules.  It attempts to find the dll base address, the size and the entry point and then load that at runtime for usage (specifically here ntdll and kernel32)</p>
<p>The most notable part here is there is no actual payload here but the code is malicious in nature where there is a call in main to amsi.dll and then finally to EtwEventWrite.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image15.png" alt=""></p>
<p>This appears to be a way to bypass ETW (Event Tracing for Windows), which is at the Kernel level and what a lot of EDR and AV watch.  The obfuscation being used here leverages C# as detection of this bypass can only gather information like namespace names, class names, and method names.  There are numerous articles on why and how this work but one such that explains it at a high level is:</p>
<p>hxxps://whiteknightlabs[.]com/2021/12/11/bypassing-etw-for-fun-and-profit/</p>
<p>Since this code doesn’t contain any payloads, it&rsquo;s likely setting up for EDR/AV bypass so the other executable launched at the same time can work without interruption.  </p>
<p>Appendix:</p>
<p>As referenced here: hxxps://perception-point[.]io/blog/the-rebranded-crypter-scrubcrypt/</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image16.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/scrubCrypt/image17.png" alt=""></p>
<h1 id="additional-file-hashes">Additional File Hashes</h1>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
<th>Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sandra_docs.bat</td>
<td>Initial Batch File</td>
<td>7a59b2513c63be2b233660f4d634ea52</td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
