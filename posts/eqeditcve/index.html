<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>CVE–2017–11882 Debugging</title>
    <meta name="description" content="Debugging ShellCode From This CVE">
    <meta name="keywords" content='blog, gokarna, hugo'>

    <meta property="og:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/eqeditcve/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="CVE–2017–11882 Debugging">
    <meta property="og:description" content="Debugging ShellCode From This CVE">
    <meta property="og:image" content="https://xd43d41u5x.github.io/images/avatar.png">
    <meta property="og:image:secure_url" content="https://xd43d41u5x.github.io/images/avatar.png">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="CVE–2017–11882 Debugging">
    <meta name="twitter:description" content="Debugging ShellCode From This CVE">
    <meta property="twitter:domain" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/eqeditcve/">
    <meta property="twitter:url" content="https://xd43d41u5x.github.io/malwaREAnalysis/posts/eqeditcve/">
    <meta name="twitter:image" content="https://xd43d41u5x.github.io/images/avatar.png">

    
    <link rel="canonical" href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/eqeditcve/" />

    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://xd43d41u5x.github.io/malwaREAnalysis//css/dark.css">

    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/svg-injector.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/feather-icons.min.js"></script>
    <script src="https://xd43d41u5x.github.io/malwaREAnalysis/js/main.js"></script>

    
    
        <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css" integrity="sha384-Xi8rHCmBmhbuyyhbI88391ZKP2dmfnOl4rT9ZfRI7mLTdk1wblIUnrIq35nqwEvC" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js" integrity="sha384-X/XCfMm41VSsqRNQgDerQczD69XqmjOOOwYQvr/uuC+j4OPoNhVgjdGFwhvN02Ja" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          // customised options
          // • auto-render specific keys, e.g.:
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
          ],
          // • rendering keys, e.g.:
          throwOnError : false
        });
      });
    </script>
  
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://xd43d41u5x.github.io/malwaREAnalysis/">
                <img src="https://xd43d41u5x.github.io/malwaREAnalysis//images/avatar.png" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://xd43d41u5x.github.io/malwaREAnalysis/">xd43D41U5x</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/"><span data-feather='home'></span> Home </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/posts/"><span data-feather='book'></span> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://xd43d41u5x.github.io/malwaREAnalysis/projects/"><span data-feather='code'></span> Projects </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/xd43D41U5x"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>CVE–2017–11882 Debugging</h1>
        <small role="doc-subtitle">Debugging ShellCode From This CVE</small>
        <p class="post-date">
            October 20, 2023
        </p>

        <ul class="post-tags">
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>While looking at a recent sample, I found it was specifically tied to CVE-2017-11882.  As you can tell, this is not a new vuln, however it does seem to still be active by evidence of this and other similar newer samples.  It appears that older versions of MS Office can include equation editor, which this CVE applies.  </p>
<p>Basically, there is a value passed to EQNEDT32.EXE, which is the out of process COM object that Excel uses for these equations.  This COM Object has a fixed size available for a certain parameter (font name) that if you pass a large value, you can overwrite the return address and have it return to your code instead (standard buffer overflow).</p>
<p>For this sample, it will return to shellcode instead.  For additional reading about this CVE, here is the article I referenced:</p>
<p><a href="https://www.google.com/url?q=https://www.fortinet.com/blog/threat-research/excel-document-delivers-malware-by-exploiting-cve-2017-11882&amp;sa=D&amp;source=editors&amp;ust=1697746902451121&amp;usg=AOvVaw2iU4JQnGQmkBj_cRDwZ-oI">https://www.fortinet.com/blog/threat-research/excel-document-delivers-malware-by-exploiting-cve-2017-11882</a></p>
<p>This post will not be about specific items covered in that and many other articles, since it is an excellent write-up and there would be no value added.  However, while working through this, I wanted to step through with things like Ghidra and X32dbg to follow each step in the shellcode.  The issue is that getting this process to wait while you attach with a debugger is difficult and since this is an out of process COM object, you can’t attach to the Excel process and step through.  I’m going to focus this post on how I got a debugger successfully attached and actions the shellcode takes.</p>
<p>First, we need to identify where in the excel file this attack is happening.  Treating the excel file like a standard compressed file, we can look at the embeddings section:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image8.png" alt=""></p>
<p>The other article has a nice diagram on how this is actually auto loaded and we will skip that here.  Long/Short, the file is set up in a way that this embedding is loaded as an ole object automatically on opening.</p>
<p>Looking at this ole object, it has a standard header “doc file - D0CF11E”, we would expect:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image4.png" alt=""></p>
<p>This will be made up of two files that 7zip can extract.  Looking at that file, you can see the same type of overflow here (null term’d 30H):</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image7.png" alt=""></p>
<p>The last part of this will overwrite the return pointer and send it to the start of our shellcode.  Since this is how the documented vuln works and we know it will try to return to “B8 5E” here, we need to do something at this point to stop the code and wait for us to attach with a debugger.</p>
<p>What we can do is overwrite the first two bytes here, the “B8 5E”, with “EB FE”.  “EB” is “jump directly to” and “FE” is basically itself.  So we are creating a small infinite loop here.  Will will continue to run until we can attach and pause it with x32dbg.</p>
<p>We will make this change in a hex editor, then change the extension on the zip (excel file) back to its original, here xlam:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image17.png" alt=""></p>
<p>One note about xlam.  For this to work, it has to be later than Office 2003 (or the older with compatibility packs installed), plus the equation editor seemed to be an optional feature on my install. In addition, the new versions of Office have been patched for this, which basically just removed the equation editor object altogether as it was deemed by MS to be “unfixable”. I guess my point here is that, this exploit is targeting a very narrow window of users.</p>
<p>So now, with our newly patched looping shellcode, just launch the xlam file and attach to EQNEDT32.EXE with X32dbg and pause it.  We are now at our loop:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image11.png" alt=""></p>
<p>We can also see that due to our patch, other items are a little messed up due to opcode parsing.  Let&rsquo;s fix that now.  This is the original MOV instruction, b8 5e a4 6a f4.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image1.png" alt=""></p>
<p>Which looks like this in x32dbg:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image20.png" alt=""></p>
<p>Now it looks correct without updates bytes shown in red:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image24.png" alt=""></p>
<p>Now we can see the setup.  F46AA45E is moved into EAX and BDB18DE is added, resulting in 0x0045BD3C and that pointer is moved into EDX.  FFB9984F is moved into EBX and then NOT’d, which produces the value, 004667B0.  X32dbg calls it out but if you look in Ghidra, you can see that is the address of the pointer to the external function Kernel32, GlobalLock:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image23.png" alt=""></p>
<p>This will basically lock a memory object and return a pointer to the first byte in that block.  We saw that a pointer to the value calculated in EAX was pushed onto the stack via EDX right before this is called.</p>
<p>The offset “5E” is added to this returned pointer and it jumps to that location.  Then come the jumps:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image5.png" alt=""></p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image15.png" alt=""></p>
<p>&lt;snip’d a few additional jumps and calls&gt;</p>
<p>Resulting in being taken to an offset in the loaded code from the ole object:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image14.png" alt=""></p>
<p>There are about a dozen jumps here, which we won’t go through but I would assume it is to add complexity in reversing.  The next important item is EDI being zero’d out:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image10.png" alt=""></p>
<p>With that zero’d, we are now setting up to decrypt the needed string values for the rest of the operations.  In each iteration, EDI is multiplied (signed) with 7A835F5F:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image6.png" alt=""></p>
<p>Then, 2F72D1BB is added to it.  That value is then XOR’d with the dword (4 bytes) at the location in EBX.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image12.png" alt=""></p>
<p>EBX starting location:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image16.png" alt=""></p>
<p>Which is an offset in our malicious ole object:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image22.png" alt=""></p>
<p>For example, in this first round, the value in EDI:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image13.png" alt=""></p>
<p>Is XOR’d with this value:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image26.png" alt=""></p>
<p>Resulting in:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image9.png" alt=""></p>
<p>If you are doing these calculations by hand remember the encrypted word value is in little endian.</p>
<p>Just to help visualize, let’s write this in Python and pass in the block that it is decoding.  Since I didn’t mention earlier, the length is determined by comparing EBX to EAX.  Basically the start down to the large block with “00 0D”.</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image25.png" alt=""></p>
<p>This will produce hex output:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image21.png" alt=""></p>
<p>Interesting strings can seen in this output, most notably the IP of the next stage, file names created and Windows apis used to perform these actions.</p>
<pre tabindex="0"><code>kernel32

LoadLibraryW

GetProcAddress

ExpandEnvironmentStringsW

%APPDATA%\\SCV.vbs

CreateFileW

WinHttp

WinHttpOpen

WinHttpConnect

94.156.161.167

WinHttpOpenRequest

/LBK.vbs

GET

WinHttpSendRequest

WinHttpReceiveResponse

WriteFile

WinHttpQueryDataAvailable

WinHttpReadData

CloseHandle

shell32

ShellExecuteW

ExitProcess
</code></pre><p>Following this further, it does as expected and attempts to find “LoadLibraryW”, then “GetProcAddress” and then “ExpandEnvironmentStringsW”, with the appdata value being passed as an arg.  For each of these its calling GetProcAddress with the arg being the handle to the loaded libraries.</p>
<p>Next, CreateFile is called, attempting a read file on SCV.vbs:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image19.png" alt=""></p>
<p>The key here is that the final param #5 is dwCreationDisposition.  As it is set to “2”, it will create this file if not found, which it does.</p>
<p>After which, it proceeds down the list with WinHttpOpen followed by WinHttpConnect with the expected params:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image3.png" alt=""></p>
<p>The port here is shown as 0x50, ie: port 80.  Followed by WinHttpOpenRequest/WinHttpRequestSend/WinHttpReceiveResponse, which is:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image2.png" alt=""></p>
<p>Attempting a GET on that IP for LBK.vbs.</p>
<p>This full request as seen from wireshark:</p>
<p><img src="https://xd43d41u5x.github.io/malwaREAnalysis/images/posts/eqEditCVE/image18.png" alt=""></p>
<p>The next few functions just setup to write (WriteFile) the content to the previous file SCV.vbs.  It then uses ShellExecuteW to run this downloaded file.  Unfortunately, the specific file returns a 404 now and the result VT has for this is the same result (404).  There are others hosted there that do return 200’s, however it would be hard to say that it is the same thing.  Because of that, we will stop here.</p>
<p>Hopefully this was helpful in understanding how we can reverse and step through the shell code that is part of this piece of malware.  While this is specific to this CVE, this same method could be applied to any similar attack where you need shellcode to wait on you.</p>
<hr>
<h1 id="files-and-scripts">Files and Scripts</h1>
<table>
<thead>
<tr>
<th>File</th>
<th>Description</th>
<th>Hash</th>
</tr>
</thead>
<tbody>
<tr>
<td>PI. 2100002 (BT-INC).xlam</td>
<td>Excel File Exploiting this CVE</td>
<td>8a85ff177bf68f376936e23909361d15</td>
</tr>
</tbody>
</table>
<hr>
<table>
<thead>
<tr>
<th>Tool Name</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr>
<td>Decode Script</td>
<td><a href="https://github.com/xd43D41U5x/Scripts/blob/87bf0528199c574d23ec30264e1da38daa92dd97/Random_WriteUp_OneOffs/CVE_2017_11882.py">Link</a></td>
</tr>
</tbody>
</table>

        </p>
        
    </div>

    <div class="prev-next">
        
    </div>
</div>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
